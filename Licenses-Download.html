<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>FOLIO Licenses Viewer</title>
    <!-- ✅ DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .form-container {
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-container h2 {
        margin-top: 0;
        color: #333;
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin: 10px 0;
        font-size: 14px;
        color: #333;
      }
      input[type="text"],
      input[type="password"] {
        padding: 10px;
        width: 100%;
        max-width: 400px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-top: 5px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        margin-right: 10px;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #0056b3;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      th {
        background-color: #f8f8f8;
        font-weight: 600;
      }
      .success {
        color: #155724;
        background: #d4edda;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .error {
        color: #721c24;
        background: #f8d7da;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>FOLIO Licenses</h2>
      <label>
        Base URL:
        <input
          type="text"
          id="baseUrl"
          value="https://folio-quesnelia-okapi.dev.folio.org"
        />
      </label>
      <label>Tenant: <input type="text" id="tenant" value="diku" /></label>
      <label
        >Username: <input type="text" id="username" value="diku_admin"
      /></label>
      <label
        >Password: <input type="password" id="password" value="admin"
      /></label>
      <button onclick="fetchLicenses()">ライセンスを取得</button>
      <button id="downloadBtn" onclick="downloadCSV()" disabled>
        CSVダウンロード
      </button>
    </div>

    <div class="form-container">
      <h2>ライセンステーブル</h2>
      <div id="message"></div>
      <table id="licensesTable">
        <thead id="licensesHeader">
          <tr>
            <th>ID</th>
            <th>Created</th>
            <th>Name</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ✅ jQuery & DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
      async function fetchLicenses() {
        const baseUrl = document.getElementById("baseUrl").value;
        const tenant = document.getElementById("tenant").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const messageEl = document.getElementById("message");

        messageEl.innerHTML = "";

        const loginResponse = await fetch(`${baseUrl}/authn/login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-okapi-tenant": tenant,
          },
          body: JSON.stringify({ username, password }),
        });

        if (!loginResponse.ok) {
          messageEl.innerHTML = '<div class="error">認証に失敗しました</div>';
          return;
        }

        const token = loginResponse.headers.get("x-okapi-token");

        const table = document.getElementById("licensesTable");
        const tableBody = table.querySelector("tbody");
        const tableHeader = document
          .getElementById("licensesHeader")
          .querySelector("tr");
        const downloadBtn = document.getElementById("downloadBtn");
        tableBody.innerHTML = "";
        messageEl.innerHTML = "";
        downloadBtn.disabled = true;

        const customPropLabels = new Set();
        const licenseRows = [];

        let page = 1;
        const perPage = 100;
        let totalPages = 1;

        do {
          const res = await fetch(
            `${baseUrl}/licenses/licenses?stats=true&page=${page}&perPage=${perPage}`,
            {
              headers: { "x-okapi-token": token },
            }
          );

          if (!res.ok) break;

          const data = await res.json();
          totalPages = data.totalPages || 1;

          for (const lic of data.results) {
            const rowData = {
              baseCells: [
                lic.id,
                lic.dateCreated?.substring(0, 10) || "",
                lic.name,
                lic.status?.label || "",
              ],
              customProps: {},
            };

            for (const key in lic.customProperties) {
              for (const item of lic.customProperties[key]) {
                const label = item.type?.label || key;
                customPropLabels.add(label);
                const val =
                  typeof item.value === "object" && item.value !== null
                    ? item.value.label || JSON.stringify(item.value)
                    : item.value;
                rowData.customProps[label] = val;
              }
            }

            licenseRows.push(rowData);
          }

          page++;
        } while (page <= totalPages);

        const customPropLabelList = Array.from(customPropLabels);

        // ヘッダーに追加
        for (const label of customPropLabelList) {
          if (!tableHeader.querySelector(`th[data-label="${label}"]`)) {
            const th = document.createElement("th");
            th.setAttribute("data-label", label);
            th.textContent = label;
            tableHeader.appendChild(th);
          }
        }

        // 行を出力
        for (const lic of licenseRows) {
          const row = tableBody.insertRow();
          for (const val of lic.baseCells) {
            const td = document.createElement("td");
            td.textContent = val;
            row.appendChild(td);
          }
          for (const label of customPropLabelList) {
            const td = document.createElement("td");
            td.textContent = lic.customProps[label] || "";
            row.appendChild(td);
          }
        }

        if (licenseRows.length > 0) {
          downloadBtn.disabled = false;
          messageEl.innerHTML =
            '<div class="success">ライセンスの取得が完了しました！</div>';
          // ✅ DataTablesを初期化（再読み込み防止のため destroy: true）
          if ($.fn.DataTable.isDataTable("#licensesTable")) {
            $("#licensesTable").DataTable().destroy();
          }
          $("#licensesTable").DataTable({
            paging: false,
            lengthChange: false,
            searching: true,
            ordering: true,
            info: false,
          });
        } else {
          messageEl.innerHTML =
            '<div class="error">ライセンスが見つかりませんでした。</div>';
        }
      }

      function downloadCSV() {
        const table = document.getElementById("licensesTable");
        const rows = Array.from(table.querySelectorAll("tbody tr"));

        if (rows.length === 0) {
          alert("CSVに出力するデータがありません。");
          return;
        }

        const headerCells = Array.from(table.querySelectorAll("thead tr th"));
        const header = headerCells
          .map((th) => `"${th.innerText.replace(/"/g, '""')}"`)
          .join(",");

        const csvRows = rows.map((row) => {
          const cells = Array.from(row.querySelectorAll("td"));
          return cells
            .map((cell) => {
              let text = cell.innerText;
              if (
                text.includes('"') ||
                text.includes(",") ||
                text.includes("\n")
              ) {
                text = '"' + text.replace(/"/g, '""') + '"';
              }
              return text;
            })
            .join(",");
        });

        const csv = [header, ...csvRows].join("\n");

        const now = new Date();
        const pad = (num) => String(num).padStart(2, "0");
        const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(
          now.getDate()
        )}${pad(now.getHours())}${pad(now.getMinutes())}${pad(
          now.getSeconds()
        )}`;
        const filename = `licenses_${timestamp}.csv`;

        const blob = new Blob(["\uFEFF" + csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
