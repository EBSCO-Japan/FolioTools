<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AgreementLines (+Package Info auto-load)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css"/>
    <style>
      #agreementsTable tbody tr.selected-row td {background-color: #fff3cd !important;}
      body{font-family:Arial, sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5;}
      .form-container{margin:20px 0;padding:20px;border-radius:8px;background:white;box-shadow:0 2px 4px rgba(0,0,0,.1);} 
      .head-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
      .head-row h2{margin:0}
      label{display:block;margin:10px 0;font-size:14px;}
      input[type="text"],input[type="password"]{padding:10px;width:100%;max-width:520px;box-sizing:border-box;margin-top:5px;}
      button{padding:10px 20px;margin-top:10px;margin-right:10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}
      button:disabled{background:#ccc;cursor:not-allowed;}
      button:hover:not(:disabled){background:#0056b3;}
      .table-wrapper{overflow-x:auto;}
      table{border-collapse:collapse;margin-top:20px;width:100%;background:white;}
      th,td{border:1px solid #ddd;padding:8px;vertical-align:top;}
      th{background:#f8f8f8;}
      .success{color:#155724;background:#d4edda;padding:10px;margin:10px 0;border-radius:4px;}
      .error{color:#721c24;background:#f8d7da;padding:10px;margin:10px 0;border-radius:4px;}
      .info{color:#004085;background:#cce5ff;padding:10px;margin:10px 0;border-radius:4px;}
      .subtle{color:#555;font-size:14px;}
      .badge{display:inline-block;background:#eef2ff;color:#334;border:1px solid #ccd;padding:2px 8px;border-radius:999px;font-size:12px;}
      .small{font-size:12px;color:#666;}
      code.k{background:#f1f1f1;padding:1px 4px;border-radius:4px;}
      #loadingMsg{margin:10px 0;font-size:14px;color:#555;}
      /* DataTables å¹…è¨ˆç®—ã®å®‰å®šåŒ– */
      table.dataTable { border-collapse: separate !important; border-spacing: 0 !important; }
      #linesTable th, #linesTable td { white-space: nowrap; }
      .dataTables_wrapper .dataTables_scrollHead, 
      .dataTables_wrapper .dataTables_scrollBody { overflow: auto; }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>AgreementLines å–å¾—ãƒ„ãƒ¼ãƒ«</h2>
      <label>Okapi Base URL:
        <input type="text" id="baseUrl" value="https://folio-snapshot-2-okapi.dev.folio.org" />
      </label>
      <label>Tenant:
        <input type="text" id="tenant" value="diku" />
      </label>
      <label>Username:
        <input type="text" id="username" value="diku_admin" />
      </label>
      <label>Password:
        <input type="password" id="password" value="admin" />
      </label>
      <hr class="small"/>
      <div class="small">â–¼å¥‘ç´„æ˜ç´°ï¼ˆAgreement Lineï¼‰ã®ã¿å–å¾—ã™ã‚‹å ´åˆã¯ä¸è¦ã§ã™ã€‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚‚åŒæ™‚ã«è‡ªå‹•å–å¾—ãƒ»è¡¨ç¤ºã—ãŸã„å ´åˆã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã™ã‚‹å ´åˆã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
       <label>Customer IDï¼ˆä»»æ„ï¼‰:
        <input type="text" id="hiqCustomerId" placeholder="ä¾‹: s1234567" />
      </label>
      <label>Holdings IQ API Keyï¼ˆä»»æ„ï¼‰:
        <input type="text" id="hiqApiKey" placeholder="ä¾‹: evasfSEFg234..." />
      </label>
      <button id="btnLogin">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="btnReloadAgreements" disabled>Agreementä¸€è¦§ã‚’å–å¾—</button>
      <div id="message" class="small"></div>
    </div>

    <div class="form-container" id="agreementsBox" style="display:none;">
      <h2>å¥‘ç´„ï¼ˆAgreementï¼‰ä¸€è¦§</h2>
      <div class="table-wrapper">
        <table id="agreementsTable">
          <thead>
            <tr>
              <th>æ˜ç´°å–å¾—</th>
              <th>ID</th>
              <th>Name</th>
              <th>Start Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="linesBox" class="form-container" style="display:none;">
      <div class="head-row">
        <h2>å¥‘ç´„æ˜ç´°ï¼ˆAgreement Lineï¼‰</h2>
        <button id="btnDownloadCSVLines" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ˜ç´°ï¼‰</button>
      </div>
      <div class="small">Reference: VendorID - PackageID - KBID / VendorID - PackageID</div>
      <div id="loadingMsg"></div>
      <div class="table-wrapper">
        <table id="linesTable">
          <thead>
            <tr>
              <th>Level</th>
              <th>Entitlement ID</th>
              <th>Reference</th>
              <th>Label</th>
              <th>Provider</th>
              <th>Package Name</th>
              <th>Publication Type</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- â–¼ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ï¼ˆæ˜ç´°å–å¾—ã¨åŒæ™‚ã«è‡ªå‹•å–å¾—ï¼‰ -->
    <div id="packageInfoBox" class="form-container" style="display:none;">
      <h2>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±</h2>
      <div id="packageInfoMsg" class="small"></div>
      <!-- ğŸ”´ è¿½åŠ ï¼šå€‹åˆ¥ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤ºé ˜åŸŸï¼ˆç´¯ç©è¡¨ç¤ºï¼‰ -->
      <div id="packageInfoErr" class="small"></div>
      <div class="table-wrapper">
        <table id="packageInfoTable">
          <thead>
            <tr>
              <th>æ“ä½œ</th>
              <th>Vendor ID</th>
              <th>Package ID</th>
              <th>Package name</th>
              <th>Vendor name</th>
              <th>Selected count</th>
              <th>Title count</th>
              <th>Package free access</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- â–² ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ± -->

    <!-- â–¼ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã®ä¸‹ã«è¡¨ç¤ºï¼‰ -->
    <div id="packageTitlesBox" class="form-container" style="display:none;">
      <div class="head-row">
        <h2 id="packageTitlesHeading">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§</h2>
        <button id="btnDownloadCSVTitles" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰</button>
      </div>
      <div id="packageTitlesMsg" class="small"></div>
      <div class="table-wrapper">
        <table id="packageTitlesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title name</th>
              <th>Title ID</th>
              <th>Resource type</th>
              <th>Selected</th>
              <th>URL</th>
              <th>Print ISSN</th>
              <th>Online ISSN</th>
              <th>Print ISBN</th>
              <th>Online ISBN</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- â–² ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ -->

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
    <script>
      // â–¼ ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / DataTable
      let pkgTitlesCache = new Map(); // packageId -> { list:[], total:number, name:string }
      let dtPkgTitles = null;

      // âœ… è¿½åŠ ï¼šç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§å¯¾è±¡ï¼ˆå…¨ä»¶CSVå‡ºåŠ›ã§ä½¿ç”¨ï¼‰
      let currentPackageIdForTitles = '';
      let currentPackageNameForTitles = '';

      function showPackageTitlesBox(show){
        const box = document.getElementById('packageTitlesBox');
        if (box) box.style.display = show ? 'block' : 'none';
      }
      function setPackageTitlesMsg(html, cls='info'){
        const el = document.getElementById('packageTitlesMsg');
        if (el) el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }
      function resetPackageTitlesUI(){
        const table = document.getElementById('packageTitlesTable');
        if(!table) return;
        try{
          if ($.fn.DataTable.isDataTable(table)) {
            $(table).DataTable().destroy(true);
          }
        }catch(_){ }
        // ãƒ†ãƒ¼ãƒ–ãƒ«éª¨çµ„ã¿å†ç”Ÿæˆ
        const wrapper = table.closest('.table-wrapper');
        if(wrapper){
          wrapper.innerHTML = `
            <table id="packageTitlesTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Title name</th>
                  <th>Title ID</th>
                  <th>Resource type</th>
                  <th>Selected</th>
                  <th>URL</th>
                  <th>Print ISSN</th>
                  <th>Online ISSN</th>
                  <th>Print ISBN</th>
                  <th>Online ISBN</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>`;
        }
        dtPkgTitles = null;
        setPackageTitlesMsg('');
        showPackageTitlesBox(false);
        const b = document.getElementById('btnDownloadCSVTitles');
        if (b) b.disabled = true;
        currentPackageIdForTitles = '';
        currentPackageNameForTitles = '';
      }

      // â–¼ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ± UI
      function showPackageInfoBox(show){
        const box = document.getElementById('packageInfoBox');
        if (box) box.style.display = show ? 'block' : 'none';
      }
      function setPackageInfoMsg(html, cls='info'){
        const el = document.getElementById('packageInfoMsg');
        if (el) el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }
      // ğŸ”´ è¿½åŠ ï¼šå€‹åˆ¥ã‚¨ãƒ©ãƒ¼ã‚’è¿½è¨˜è¡¨ç¤ºã™ã‚‹
      function appendPackageInfoErr(html){
        const el = document.getElementById('packageInfoErr');
        if(!el) return;
        const div = document.createElement('div');
        div.className = 'error';
        div.innerHTML = html;
        el.appendChild(div);
      }
      function resetPackageInfoUI(){
        const table = document.getElementById('packageInfoTable');
        if(!table) return;
        const tbody = table.querySelector('tbody');
        if(tbody) tbody.innerHTML = '';
        setPackageInfoMsg('');
        const err = document.getElementById('packageInfoErr');
        if(err) err.innerHTML = '';
        showPackageInfoBox(false);
      }

      // --- Agreements table reset (rebuild skeleton & destroy DataTable) ---
      function resetAgreementsUI(){
        const currentTable = document.getElementById('agreementsTable');
        if(!currentTable) return;
        const wrapper = currentTable.closest('.table-wrapper') || currentTable.parentElement;
        try{
          if ($.fn.DataTable && $.fn.DataTable.isDataTable(currentTable)) {
            $(currentTable).DataTable().destroy(true);
          }
        }catch(_){ }
        if(!agreementsTableTemplateHTML){
          agreementsTableTemplateHTML = currentTable.outerHTML;
        }
        if(wrapper){
          wrapper.innerHTML = agreementsTableTemplateHTML;
        }
      }
      // Agreementsè¡Œã‚’DataTablesã«å…¥ã‚Œã‚„ã™ã„å½¢ã¸
function agreementRowFromItem(a){
  return [
    `<button class="detail-btn" data-id="${escapeHtml(String(a.id))}">æ˜ç´°å–å¾—</button>`,
    escapeHtml(String(a.id)),
    escapeHtml(a.name || ''),
    escapeHtml((a.startDate || '').slice(0,10)),
    escapeHtml((a.agreementStatus && a.agreementStatus.label) || '')
  ];
}

  // Agreementsç”¨ DataTable åˆæœŸåŒ–ï¼ˆç©ºã§ç«‹ã¡ä¸Šã’ã‚‹ï¼‰
  function initAgreementsTable(){
    const tbody = document.querySelector('#agreementsTable tbody');
    if (tbody) tbody.innerHTML = '';
    if (dtAgreements) { dtAgreements.destroy(); }
    dtAgreements = $('#agreementsTable').DataTable({
      paging:false, searching:true, ordering:true, info:false,
      scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 }, scrollY:"260px",
      deferRender:true
    });
    dtAgreements.columns.adjust();
  }

  // ãƒšãƒ¼ã‚¸ã§å–å¾—ã—ãŸåˆ†ã‚’éƒ½åº¦è¿½åŠ 
  function appendAgreementsRows(items){
    if (!dtAgreements) initAgreementsTable();
    const rows = (items || []).map(agreementRowFromItem);
    if (rows.length) {
      dtAgreements.rows.add(rows).draw(false);
    }
  }

      // â–¼ Okapi / çŠ¶æ…‹
      let okapi = { base:'', tenant:'', token:'' };
      let hiq = { apiKey:'', customerId:'' }; // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è©³ç´°ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§å–å¾—ã«ä½¿ç”¨
      let selectedAgreementId = '';
      let selectedDetails = null;
      let dtLines = null, dtAgreements = null;
      let activeAgreementSeq = 0;
      let linesTableTemplateHTML = '';
      let agreementsTableTemplateHTML = '';

      const msg = (html, cls='info') => {
        document.getElementById('message').innerHTML = `<div class="${cls}">${html}</div>`;
      };

      function setLinesMsg(html, cls='info'){
        const el = document.getElementById('loadingMsg');
        if (!el) return;
        el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }

      // --- Login (Okapi) ---
      async function login(){
        const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
        const tenant = document.getElementById('tenant').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        hiq.apiKey = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

        if(!baseUrl || !tenant || !username || !password){
          msg('Okapi: Base URL / Tenant / Username / Password ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚','error');
          return;
        }

        msg('ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦');
        try{
          const res = await fetch(`${baseUrl}/authn/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-okapi-tenant": tenant },
            body: JSON.stringify({ username, password })
          });
          if(res.status !== 201){ msg(`èªè¨¼å¤±æ•—: ${res.status}`, 'error'); return; }
          const token = res.headers.get('x-okapi-token');
          if(!token){ msg('ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ã‚Šã¾ã›ã‚“ï¼ˆAccess-Control-Expose-Headers è¨­å®šè¦ï¼‰ã€‚', 'error'); return; }
          okapi = { base: baseUrl, tenant, token };
          msg('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€‚æ¬¡ã«ã€ŒAgreementä¸€è¦§ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
          document.getElementById('btnReloadAgreements').disabled = false;
          const b = document.getElementById('btnDownloadCSVLines');
          if (b) b.disabled = true;
        }catch(e){ msg('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
      }

      // --- Agreements list / details ---
      // --- Agreements list / details ---
async function loadAgreements(){
  if(!okapi.token){ msg('å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚','error'); return; }

  msg('Agreementä¸€è¦§ã‚’å–å¾—ä¸­â€¦');
  try{
    const perPage = 20;                  // â† ã“ã“ã‚’20ã«
    let page = 1, totalPages = 1;
    let totalRecords = null;
    let fetched = 0;

    const baseUrl = `${okapi.base}/erm/sas?sort=name%3Basc&stats=true&perPage=${perPage}`;

    // UIæº–å‚™ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç©ºã§ç«‹ã¡ä¸Šã’ã€ã™ãè¡¨ç¤º
    document.getElementById('agreementsBox').style.display = 'block';
    resetAgreementsUI();
    initAgreementsTable();

    // 1ãƒšãƒ¼ã‚¸ç›®
    let res = await fetch(`${baseUrl}&page=${page}`, { headers: { 'x-okapi-token': okapi.token } });
    if(!res.ok){ msg('Agreement å–å¾—å¤±æ•—: ' + res.status, 'error'); return; }
    let data = await res.json();

    totalPages = data.totalPages || 1;
    totalRecords = (typeof data.totalRecords === 'number'
                   ? data.totalRecords
                   : (typeof data.total === 'number' ? data.total : null));

    const firstChunk = data.results || [];
    appendAgreementsRows(firstChunk);
    fetched += firstChunk.length;

    msg(`Agreementä¸€è¦§ã‚’å–å¾—ä¸­â€¦ ãƒšãƒ¼ã‚¸ ${page}/${totalPages} ãƒ» å–å¾— ${fetched}${totalRecords!=null?`/${totalRecords}`:''}`, 'info');

    // 2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ï¼šå–å¾—ã—ãªãŒã‚‰éƒ½åº¦è¿½åŠ ï¼‹é€²æ—æ›´æ–°
    for(page = 2; page <= totalPages; page++){
      res = await fetch(`${baseUrl}&page=${page}`, { headers: { 'x-okapi-token': okapi.token } });
      if(!res.ok){ msg('Agreement å–å¾—å¤±æ•—: ' + res.status, 'error'); return; }
      data = await res.json();

      const chunk = data.results || [];
      appendAgreementsRows(chunk);
      fetched += chunk.length;

      msg(`Agreementä¸€è¦§ã‚’å–å¾—ä¸­â€¦ ãƒšãƒ¼ã‚¸ ${page}/${totalPages} ãƒ» å–å¾— ${fetched}${totalRecords!=null?`/${totalRecords}`:''}`, 'info');
    }

    const totalMsg = totalRecords != null
      ? `ï¼ˆ${fetched}ä»¶ / æœŸå¾… ${totalRecords}ä»¶, å…¨${totalPages}ãƒšãƒ¼ã‚¸ï¼‰`
      : `ï¼ˆ${fetched}ä»¶ / å…¨${totalPages}ãƒšãƒ¼ã‚¸ï¼‰`;
    msg('Agreement å–å¾—å®Œäº† ' + totalMsg, 'success');

  }catch(e){
    msg('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

      // function renderAgreementsTable(items){
      //   const tbody = document.querySelector('#agreementsTable tbody');
      //   tbody.innerHTML = '';
      //   items.forEach(a => {
      //     const tr = document.createElement('tr');
      //     tr.innerHTML =
      //       '<td><button class="detail-btn" data-id="' + escapeHtml(String(a.id)) + '">æ˜ç´°å–å¾—</button></td>' +
      //       '<td>' + escapeHtml(String(a.id)) + '</td>' +
      //       '<td>' + escapeHtml(a.name || '') + '</td>' +
      //       '<td>' + escapeHtml((a.startDate || '').slice(0,10)) + '</td>' +
      //       '<td>' + escapeHtml((a.agreementStatus && a.agreementStatus.label) || '') + '</td>';
      //     tbody.appendChild(tr);
      //   });
      //   if(dtAgreements){ dtAgreements.destroy(); }
      //   dtAgreements = $('#agreementsTable').DataTable({
      //     paging:false, searching:true, ordering:true, info:false,
      //     scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 }, scrollY:"260px"
      //   });
      //   dtAgreements.columns.adjust();
      // }

      async function onPickAgreement(agreementId){
        activeAgreementSeq++;
        const seq = activeAgreementSeq;
        selectedAgreementId = agreementId;

        // è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆ
        const allRows = document.querySelectorAll('#agreementsTable tbody tr');
        allRows.forEach(tr => tr.classList.remove('selected-row'));
        const btn = document.querySelector(`.detail-btn[data-id="${agreementId}"]`);
        if (btn) {
          const row = btn.closest('tr');
          if (row) row.classList.add('selected-row');
        }

        // åˆæœŸåŒ–
        resetLinesUI();
        resetPackageInfoUI();
        resetPackageTitlesUI();
        document.getElementById('loadingMsg').textContent = '';
        msg('Agreement(' + escapeHtml(agreementId) + ') ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸâ€¦');

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ & æ˜ç´°ã®å–å¾—
        await fetchAgreementDetails(agreementId, seq);
        await fetchEntitlements(agreementId, seq); // ã“ã“ã§è‡ªå‹•çš„ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚‚ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
      }

      async function fetchAgreementDetails(id, seq){
        msg('Agreement ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦');
        const res = await fetch(`${okapi.base}/erm/sas/${encodeURIComponent(id)}`, {
          headers: { "x-okapi-token": okapi.token }
        });
        if(!res.ok){ msg('Agreement è©³ç´°å–å¾—å¤±æ•—: ' + res.status, 'error'); return; }
        const details = await res.json();
        if(seq !== activeAgreementSeq) return;
        selectedDetails = details;
        msg('Agreement ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', 'success');
      }

      // ========== Agreement Lines å–å¾—ï¼ˆå®Œäº†å¾Œã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’è‡ªå‹•åé›†ï¼‰ ==========
      async function fetchEntitlements(agreementId, seq){
        const linesBox = document.getElementById('linesBox');
        if (linesBox) linesBox.style.display = 'block';

        setLinesMsg('Agreement Line å–å¾—ä¸­â€¦', 'info');

        const perPage = 100;
        let page = 1, totalPages = 1;
        const all = [];
        try{
          let url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
          let res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
          if(!res.ok){ setLinesMsg('Entitlements å–å¾—å¤±æ•—: ' + res.status, 'error'); return; }
          let data = await res.json();
          if(seq !== activeAgreementSeq) return;
          totalPages = data.totalPages || 1;
          all.push(...(data.results||[]));
          for(page=2; page<=totalPages; page++){
            setLinesMsg(`Agreement Line å–å¾—ä¸­â€¦ (${page}/${totalPages})`, 'info');
            url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
            res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
            if(!res.ok){ setLinesMsg('Entitlements å–å¾—å¤±æ•—: ' + res.status, 'error'); return; }
            data = await res.json();
            if(seq !== activeAgreementSeq) return;
            all.push(...(data.results||[]));
          }

          renderLinesTable(all);
          setLinesMsg(`Agreement Line å–å¾—å®Œäº†ï¼ˆåˆè¨ˆ: ${all.length}è¡Œï¼‰`, 'success');

          const b = document.getElementById('btnDownloadCSVLines');
          if (b) b.disabled = all.length === 0;

          // ğŸ”„ æ˜ç´°ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸IDã‚’æŠ½å‡ºã—ã€è‡ªå‹•ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—
          autoLoadPackageInfoForEntitlements(all);
        }catch(e){ console.error(e); setLinesMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error'); }
      }

      function renderLinesTable(items){
        const table = document.getElementById('linesTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        items.forEach(e => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-entitlement-id', e.id || '');

          // å‚ç…§ã‹ã‚‰ vendorId / packageId ã‚’æŠ½å‡ºï¼ˆå¿…è¦ã«å¿œã˜ã¦å±æ€§ã«ä¿æŒï¼‰
          const ref = (e.reference || '').trim();
          let parsed = parseReference3(ref) || parseReference2(ref);
          let pkgId = parsed?.packageId || '';
          let vId = parsed?.vendorId || '';

          if(!pkgId && e.reference_object?.packageData?.id){ pkgId = String(e.reference_object.packageData.id); }
          if(!vId && e.reference_object?.providerId){ vId = String(e.reference_object.providerId); }

          if(pkgId){ tr.setAttribute('data-package-id', String(pkgId)); }
          if(vId){ tr.setAttribute('data-vendor-id', String(vId)); }

          const authority = getAuthority(e);
          const levelBadge = authority === 'EKB-PACKAGE'
            ? '<span class="badge">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</span>'
            : '<span class="badge">ã‚¿ã‚¤ãƒˆãƒ«</span>';

          const cells = [
            levelBadge,
            safe(e.id||''),
            safe(e.reference||''),
            safe(e.reference_object?.label || ''),
            safe(e.reference_object?.provider || ''),
            safe(e.reference_object?.packageData?.name || ''),
            safe(e.reference_object?.publicationType || ''),
            linkCell(e.reference_object?.url || '')
          ];

          tr.innerHTML = cells.map((cell,i)=> (i===7) ? `<td>${cell}</td>` : `<td>${i===0?cell:escapeHtml(cell)}</td>`).join('');
          tbody.appendChild(tr);
        });

        if(dtLines){ dtLines.destroy(); }
        dtLines = $("#linesTable").DataTable({
          paging:false, searching:true, ordering:true, info:false,
          scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 },
          scrollY:"220px"
        });
        dtLines.columns.adjust();
      }

      // --- æ˜ç´°ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åé›†ã—ã€è‡ªå‹•å–å¾— ---
      async function autoLoadPackageInfoForEntitlements(items){
        // å…¥åŠ›æ¬„ã‹ã‚‰æœ€æ–°ã® HIQ è³‡æ ¼æƒ…å ±ã‚’èª­ã‚€
        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

        resetPackageInfoUI();
        showPackageInfoBox(true);

        if(!(hiq.apiKey && hiq.customerId)){
          setPackageInfoMsg('HIQ: API Key ã¨ Customer ID ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æ˜ç´°å–å¾—ã¨åŒæ™‚ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚‚è‡ªå‹•å–å¾—ã—ã¾ã™ã€‚', 'info');
          return; // è³‡æ ¼æƒ…å ±ãŒç„¡ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ˜ç´°ã¯è¡¨ç¤ºæ¸ˆã¿ï¼‰
        }

        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãª packageId ã‚’æŠ½å‡º
        const pkgIdSet = new Set();
        for(const e of items){
          const ref = (e.reference || '').trim();
          let parsed = parseReference3(ref) || parseReference2(ref);
          let pkgId = parsed?.packageId || '';
          if(!pkgId && e.reference_object?.packageData?.id){ pkgId = String(e.reference_object.packageData.id); }
          if(pkgId) pkgIdSet.add(String(pkgId));
        }

        const pkgIds = Array.from(pkgIdSet);
        if(pkgIds.length === 0){
          setPackageInfoMsg('ã“ã®å¥‘ç´„æ˜ç´°ã«ç´ã¥ããƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'info');
          return;
        }

        setPackageInfoMsg(`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—ä¸­â€¦ (0/${pkgIds.length})`);

        const detailsList = [];
        let done = 0;
        for(const pid of pkgIds){
          try{
            const details = await getPackageDetails(pid);
            detailsList.push({ packageId: pid, details });
          }catch(e){
            console.error('getPackageDetails error', pid, e);
            // ğŸ”´ ç”»é¢ã«å€‹åˆ¥ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º + ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚ã‚¨ãƒ©ãƒ¼è¡Œã‚’å‡ºã™
            appendPackageInfoErr(`Package ID <code class="k">${escapeHtml(String(pid))}</code> ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}`);
            detailsList.push({ packageId: pid, error: e.message });
          }finally{
            done++;
            setPackageInfoMsg(`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—ä¸­â€¦ (${done}/${pkgIds.length})`);
          }
        }

        renderPackageInfoTable(detailsList);
        setPackageInfoMsg(`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã®å–å¾—å®Œäº†ï¼ˆ${detailsList.length} / ${pkgIds.length}ï¼‰`, 'success');
      }

      // --- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ã®å–å¾—ï¼ˆå˜ä½“ï¼‰ ---
      async function getPackageDetails(packageId){
        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();
        if(!(hiq.apiKey && hiq.customerId)){
          throw new Error('HIQ: API Key ã¨ Customer ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
        const headers = { accept: 'application/json', 'x-api-key': hiq.apiKey };
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getPackageDetails.php';
        const url = `${base}?account=${encodeURIComponent(hiq.customerId)}&package=${encodeURIComponent(packageId)}`;
        const res = await fetch(url, { headers });
        if(!res.ok){
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘ã§ãªãã€ã©ã® Package ã‹ã‚’å‡ºã™
          throw new Error(`Package Details(${packageId}) å–å¾—å¤±æ•—: ${res.status}`);
        }
        return await res.json();
      }

      // --- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¤‡æ•°è¡Œï¼‰æç”» ---
      function renderPackageInfoTable(items){
        const table = document.getElementById('packageInfoTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        for(const it of items){
          const packageId = it.packageId;
          const details = it.details || {};

          const tr = document.createElement('tr');
          tr.setAttribute('data-package-id', String(packageId));

          // ğŸ”´ ã‚¨ãƒ©ãƒ¼è¡Œï¼šè©³ç´°ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚æ˜ç¤º
          if (it.error){
            tr.innerHTML = [
              '<span class="badge">ã‚¨ãƒ©ãƒ¼</span>',
              '',
              escapeHtml(String(packageId)),
              `<span class="error">å–å¾—å¤±æ•—: ${escapeHtml(String(it.error))}</span>`,
              '',
              '',
              '',
              ''
            ].map((c)=>`<td>${c}</td>`).join('');
            tbody.appendChild(tr);
            continue;
          }

          const pkgName  = details?.packageName ?? '';
          const vendor   = details?.vendorName  ?? '';
          const selCount = details?.selectedCount ?? '';
          const ttlCount = details?.titleCount    ?? '';
          const freeAcc  = details?.packageFreeAccess ?? '';
          const vendorId = details?.vendorId != null ? String(details.vendorId) : '';

          const canExpand = typeof details?.titleCount === 'number' && details.titleCount <= 10000;
          const opCell = canExpand
            ? `<button class="btnExpandTitles" data-package-id="${escapeHtml(String(packageId))}" data-vendor-id="${escapeHtml(String(vendorId))}" data-package-name="${escapeHtml(String(pkgName))}">ã‚¿ã‚¤ãƒˆãƒ«å±•é–‹</button>`
            : `ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã®ã‚¿ã‚¤ãƒˆãƒ«æ•°ãŒå¤šã™ãã¾ã™ã€‚HLMã‚ˆã‚ŠDLã—ã¦ãã ã•ã„`;

          if(vendorId) tr.setAttribute('data-vendor-id', String(vendorId));
          tr.innerHTML = [
            opCell,
            escapeHtml(vendorId),
            escapeHtml(String(packageId)),
            escapeHtml(pkgName),
            escapeHtml(vendor),
            escapeHtml(String(selCount)),
            escapeHtml(String(ttlCount)),
            escapeHtml(String(freeAcc))
          ].map((c)=>`<td>${c}</td>`).join('');
          tbody.appendChild(tr);
        }

        showPackageInfoBox(true);
      }

      // --- ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¿ã‚¤ãƒˆãƒ«å±•é–‹ ---
      document.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('.btnExpandTitles');
        if(!btn) return;

        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();
        if(!(hiq.apiKey && hiq.customerId)){
          msg('HIQ: API Key ã¨ Customer ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚','error');
          return;
        }

        const packageId = btn.getAttribute('data-package-id');
        const packageName = btn.getAttribute('data-package-name') || '';
        const vendorId = btn.getAttribute('data-vendor-id') || '';
        if(!packageId){ msg('Package ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚','error'); return; }

        // UI æº–å‚™
        resetPackageTitlesUI();
        currentPackageIdForTitles = packageId;
        currentPackageNameForTitles = packageName;

        const heading = document.getElementById('packageTitlesHeading');
        if(heading) heading.textContent = `ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ï¼ˆPackage ${packageId} : ${packageName || 'N/A'}ï¼‰`;
        showPackageTitlesBox(true);
        setPackageTitlesMsg('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ä¸­â€¦');

        try{
          const list = await loadPackageTitles(packageId, vendorId);
          renderPackageTitles(list);
          setPackageTitlesMsg(`å–å¾—å®Œäº†ï¼š${list.length} ä»¶`, 'success');

          const b = document.getElementById('btnDownloadCSVTitles');
          if (b) b.disabled = list.length === 0;
        }catch(e){
          console.error(e);
          setPackageTitlesMsg('ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(e.message), 'error');
          const b = document.getElementById('btnDownloadCSVTitles');
          if (b) b.disabled = true;
        }
      });

      // --- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ã®å–å¾—ï¼ˆvendor ã‚’ä»˜ä¸ï¼‰ ---
      async function loadPackageTitles(packageId, vendorId){
        if(pkgTitlesCache.has(packageId)){
          return pkgTitlesCache.get(packageId).list;
        }
        const headers = { 'accept':'application/json', 'x-api-key': hiq.apiKey };
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getPackageTitles.php';

        const out = [];
        let page = 1;
        const count = 100;
        let total = 0;
        let safety = 2000;

        while (safety-- > 0){
          const url =
            `${base}?account=${encodeURIComponent(hiq.customerId)}` +
            `&vendor=${encodeURIComponent(vendorId||'')}` +
            `&package=${encodeURIComponent(packageId)}` +
            `&count=${count}&offset=${page}&orderby=titlename&searchfield=titlename`;
          const res = await fetch(url, { headers });
          if(!res.ok){
            throw new Error(`holdings_getPackageTitles å¤±æ•—: ${res.status}`);
          }
          const data = await res.json();
          const titles = Array.isArray(data.titles) ? data.titles : [];
          total = Number(data.totalResults || 0);

          for(const t of titles){
            const h = hiqFromTitle(t);
            out.push({
              titleName: h.titleName,
              titleId:   h.titleId,
              resourceType: h.resourceType,
              selected: h.selected,
              url: h.url,
              printIssn: h.printIssn,
              onlineIssn: h.onlineIssn,
              printIsbn: h.printIsbn,
              onlineIsbn: h.onlineIsbn
            });
          }

          if(titles.length < count) break;
          const maxPage = total ? Math.ceil(total / count) : Infinity;
          page++;
          if(page > maxPage) break;

          setPackageTitlesMsg(`ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ä¸­â€¦ (${Math.min(out.length, total)}/${total||'?'})`);
        }

        pkgTitlesCache.set(packageId, { list: out, total, name: '' });
        return out;
      }

      // --- ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ---
      function renderPackageTitles(list){
        const table = document.getElementById('packageTitlesTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        list.forEach((x, i) => {
          const tr = document.createElement('tr');
          const cells = [
            String(i+1),
            safe(x.titleName),
            safe(x.titleId),
            safe(x.resourceType),
            safe(x.selected),
            x.url ? `<a href="${escapeHtml(x.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(x.url)}</a>` : '',
            safe(x.printIssn),
            safe(x.onlineIssn),
            safe(x.printIsbn),
            safe(x.onlineIsbn),
          ];
          tr.innerHTML = cells.map((c, idx)=> idx===5 ? `<td>${c}</td>` : `<td>${escapeHtml(c)}</td>`).join('');
          tbody.appendChild(tr);
        });

        dtPkgTitles = $("#packageTitlesTable").DataTable({
          paging:true, searching:true, ordering:true, info:true,
          pageLength: 25,
          scrollX:true, autoWidth:false
        });
      }

      // --- CSV Exportï¼ˆæ˜ç´°ï¼‰ ---
      function downloadCSVLines(){
        const table = document.getElementById('linesTable');
        const trs = Array.from(table.querySelectorAll('tbody tr'));
        if(!trs.length){ alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        const rows = trs.map(tr => {
          const tds = Array.from(tr.cells);
          const urlA = tds[7]?.querySelector('a');
          const cols = [
            tds[1]?.innerText || '', // Entitlement ID
            tds[0]?.innerText || '', // Level
            tds[2]?.innerText || '', // Reference
            tds[3]?.innerText || '', // Label
            tds[4]?.innerText || '', // Provider
            tds[5]?.innerText || '', // Package Name
            tds[6]?.innerText || '', // Publication Type
            urlA?.getAttribute('href') || '' // URL
          ];
          return cols.map(t => /[",\n]/.test(t) ? '"' + t.replace(/"/g,'""') + '"' : t).join(',');
        });
        const headers = ['Entitlement ID','Level','Reference','Label','Provider','Package Name','Publication Type','URL'];
        const csv = "\uFEFF" + [headers.join(','), ...rows].join('\n');
        downloadBlob(csv, `agreement_lines_${exportBaseName()}_${timestamp()}.csv`);
      }

      // --- CSV Exportï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å…¨ä»¶ã‚’æ›¸ãå‡ºã™ï¼‰ ---
      function downloadCSVTitles(){
        const pkgId = currentPackageIdForTitles;
        const cache = pkgTitlesCache.get(pkgId);
        const list = cache?.list || [];

        if(!pkgId || !list.length){
          alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ãŒæœªå–å¾—ã‹0ä»¶ã§ã™ï¼‰');
          return;
        }

        const rows = list.map(x => {
          const cols = [
            x.titleName || '',
            x.titleId || '',
            x.resourceType || '',
            x.selected || '',
            x.url || '',
            x.printIssn || '',
            x.onlineIssn || '',
            x.printIsbn || '',
            x.onlineIsbn || ''
          ];
          return cols.map(t => /[",\n]/.test(String(t)) ? '"' + String(t).replace(/"/g,'""') + '"' : String(t)).join(',');
        });

        const headers = ['Title name','Title ID','Resource type','Selected','URL','Print ISSN','Online ISSN','Print ISBN','Online ISBN'];
        const csv = "\uFEFF" + [headers.join(','), ...rows].join('\n');

        const baseName = (currentPackageNameForTitles || `package_${pkgId}`).replace(/[^a-zA-Z0-9_-]+/g,'_');
        downloadBlob(csv, `package_titles_${baseName}_${timestamp()}.csv`);
      }

      // --- å…±é€šï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
      function downloadBlob(text, filename){
        const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function timestamp(){
        const now = new Date(), pad=n=>String(n).padStart(2,'0');
        return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      }
      function exportBaseName(){
        return (selectedDetails && selectedDetails.name)
          ? selectedDetails.name.replace(/[^a-zA-Z0-9_-]+/g,'_')
          : (selectedAgreementId||'export');
      }

      function resetLinesUI(){
        const currentTable = document.getElementById('linesTable');
        if(!currentTable) return;
        const wrapper = currentTable.closest('.table-wrapper') || currentTable.parentElement;

        if(!linesTableTemplateHTML){
          linesTableTemplateHTML = currentTable.outerHTML;
        }

        try{
          if ($.fn.DataTable.isDataTable(currentTable)) {
            $(currentTable).DataTable().destroy(true);
          }
        }catch(_){ /* noop */ }
        dtLines = null;

        if(wrapper){
          wrapper.innerHTML = linesTableTemplateHTML;
        }
        const linesBox = document.getElementById('linesBox');
        if (linesBox) linesBox.style.display = 'none';

        const b = document.getElementById('btnDownloadCSVLines');
        if (b) b.disabled = true;
      }

      // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
      function hiqFromTitle(t){
        const cr = Array.isArray(t.customerResourcesList) && t.customerResourcesList.length ? t.customerResourcesList[0] : {};
        const ids = splitIdentifiers(t.identifiersList || []);
        const { begin: managedBegin, end: managedEnd } = firstCoverage(cr.managedCoverageList);
        const { begin: customBegin,  end: customEnd  } = firstCoverage(cr.customCoverageList);

        return {
          providerName: cr?.vendorName ?? t?.vendorName ?? '',
          packageName:  cr?.packageName  ?? t?.packageName  ?? '',
          titleName: t.titleName || '',
          titleId:   String(t?.titleId ?? t?.kbid ?? t?.kbId ?? ''),
          packageId: String(cr?.packageId ?? t?.listId ?? ''),
          providerId: String(cr?.vendorId ?? t?.vendorId ?? ''),
          resourceType: t.pubType || '',
          coverageManagedBegin: managedBegin,
          coverageManagedEnd:   managedEnd,
          coverageCustomBegin:  customBegin,
          coverageCustomEnd:    customEnd,
          url: cr?.url ?? t?.url ?? '',
          printIssn: ids.printIssn,
          onlineIssn: ids.onlineIssn,
          printIsbn: ids.printIsbn,
          onlineIsbn: ids.onlineIsbn,
          selected: cr && cr.isSelected ? 'Selected' : 'Not selected',
          label1: cr?.userDefinedField1 ?? t?.userDefinedField1 ?? '',
          label2: cr?.userDefinedField2 ?? t?.userDefinedField2 ?? '',
          label3: cr?.userDefinedField3 ?? t?.userDefinedField3 ?? '',
          label4: cr?.userDefinedField4 ?? t?.userDefinedField4 ?? '',
          label5: cr?.userDefinedField5 ?? t?.userDefinedField5 ?? '',
          rootProxy: cr && cr.proxy && cr.proxy.proxiedUrl ? cr.proxy.proxiedUrl : ''
        };
      }

      function firstCoverage(list){
        try{
          const c = Array.isArray(list) && list.length ? list[0] : null;
          return {
            begin: (c && c.beginCoverage) || '',
            end:   (c && c.endCoverage)   || ''
          };
        }catch(_){ return { begin:'', end:'' }; }
      }
      function splitIdentifiers(list){
        const out = { printIssn:'', onlineIssn:'', printIsbn:'', onlineIsbn:'' };
        try{
          const bySource = { 'Print ISSN': [], 'Online ISSN': [], 'Print ISBN': [], 'Online ISBN': [] };
          (list||[]).forEach(x => { if(!x || !x.id) return; if(bySource[x.source]) bySource[x.source].push(String(x.id)); });
          out.printIssn = bySource['Print ISSN'].join('; ');
          out.onlineIssn = bySource['Online ISSN'].join('; ');
          out.printIsbn = bySource['Print ISBN'].join('; ');
          out.onlineIsbn = bySource['Online ISBN'].join('; ');
        }catch(_){ /* noop */ }
        return out;
      }

      function safe(v){ return v==null? '': String(v); }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function linkCell(u){ if(!u) return ''; const esc = escapeHtml(String(u)); return `<a href="${esc}" target="_blank" rel="noopener noreferrer">${esc}</a>`; }

      function getAuthority(e){
        const a = (e.resource && e.resource.authority) || e.authority || (e.reference_object && e.reference_object.authority);
        if(a) return a;
        const ref = (e.reference || '').trim();
        if(parseReference3(ref)) return 'EKB-TITLE';
        if(parseReference2(ref)) return 'EKB-PACKAGE';
        return '';
      }
      function parseReference3(ref){ // 36 - 1515 - 968431
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2], kbId: m[3] };
      }
      function parseReference2(ref){ // 36 - 1515
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2] };
      }

      document.getElementById('btnLogin').addEventListener('click', login);
      document.getElementById('btnReloadAgreements').addEventListener('click', loadAgreements);

      // Agreementä¸€è¦§ã®ã€Œæ˜ç´°å–å¾—ã€ãƒœã‚¿ãƒ³
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.detail-btn');
        if(btn){
          const id = btn.getAttribute('data-id') || '';
          if(id){ onPickAgreement(id); }
          else { msg('Agreement ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚','error'); }
        }
      });

      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ˜ç´°ï¼‰
      document.getElementById('btnDownloadCSVLines').addEventListener('click', downloadCSVLines);
      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
      document.getElementById('btnDownloadCSVTitles').addEventListener('click', downloadCSVTitles);
    </script>
  </body>
</html>
