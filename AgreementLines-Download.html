<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AgreementLines-Download + Holdings IQ (extended, multi-export)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css"/>
    <style>
      #agreementsTable tbody tr.selected-row td {background-color: #fff3cd !important;}
      body{font-family:Arial, sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5;}
      .form-container{margin:20px 0;padding:20px;border-radius:8px;background:white;box-shadow:0 2px 4px rgba(0,0,0,.1);}
      label{display:block;margin:10px 0;font-size:14px;}
      input[type="text"],input[type="password"]{padding:10px;width:100%;max-width:520px;box-sizing:border-box;margin-top:5px;}
      button{padding:10px 20px;margin-top:10px;margin-right:10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}
      button:disabled{background:#ccc;cursor:not-allowed;}
      button:hover:not(:disabled){background:#0056b3;}
      .table-wrapper{overflow-x:auto;}
      table{border-collapse:collapse;margin-top:20px;width:100%;background:white;}
      th,td{border:1px solid #ddd;padding:8px;vertical-align:top;}
      th{background:#f8f8f8;}
      .success{color:#155724;background:#d4edda;padding:10px;margin:10px 0;border-radius:4px;}
      .error{color:#721c24;background:#f8d7da;padding:10px;margin:10px 0;border-radius:4px;}
      .info{color:#004085;background:#cce5ff;padding:10px;margin:10px 0;border-radius:4px;}
      .subtle{color:#555;font-size:14px;}
      .badge{display:inline-block;background:#eef2ff;color:#334;border:1px solid #ccd;padding:2px 8px;border-radius:999px;font-size:12px;}
      .meta-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
      .small{font-size:12px;color:#666;}
      code.k{background:#f1f1f1;padding:1px 4px;border-radius:4px;}
      #loadingMsg{margin:10px 0;font-size:14px;color:#555;}
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>AgreementLines 取得ツール</h2>
      <label>Okapi Base URL:
        <input type="text" id="baseUrl" value="https://folio-snapshot-2-okapi.dev.folio.org" />
      </label>
      <label>Tenant:
        <input type="text" id="tenant" value="diku" />
      </label>
      <label>Username:
        <input type="text" id="username" value="diku_admin" />
      </label>
      <label>Password:
        <input type="password" id="password" value="admin" />
      </label>
      <hr class="small"/>
      <label>Holdings IQ API Key（任意）:
        <input type="text" id="hiqApiKey" placeholder="例: AKIA..." />
      </label>
      <label>Customer ID（任意）:
        <input type="text" id="hiqCustomerId" placeholder="例: s1014396" />
      </label>

      <button id="btnLogin">ログイン</button>
      <button id="btnReloadAgreements" disabled>Agreement一覧を取得</button>
      <button id="btnDownloadCSV" disabled>CSVダウンロード</button>
      <div id="message" class="small"></div>


    </div>

    <div class="form-container" id="agreementsBox" style="display:none;">
      <h2>Agreement 選択</h2>
      <div class="table-wrapper">
        <table id="agreementsTable">
          <thead>
            <tr>
              <th>明細取得</th>
              <th>ID</th>
              <th>Name</th>
              <th>Start Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
      <!-- ▼ 複数巨大パッケージ用エクスポート領域 -->
      <div id="exportArea" class="form-container" style="display:none;">
        <h2>大容量タイトルのエクスポート</h2>
        <div class="small" style="margin-bottom:8px;">
          タイトル数が <code class="k">10,000</code> 件以上のパッケージが検出されると、下に並びます。各行の「DL開始」でエクスポートを実行し、完了まで自動ポーリングします。
        </div>
        <div class="table-wrapper">
          <table id="exportTable">
            <thead>
              <tr>
                <th>Package name</th>
                <th>Package ID</th>
                <th>Titles</th>
                <th>操作</th>
                <th>ステータス</th>
                <th>DLリンク</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small subtle" style="margin-top:8px;">
          ※ 進行中のジョブは5秒間隔で更新。<br/>
          ※ ブラウザから <code class="k">api.ebsco.io</code> に直接アクセスできない環境ではCORSに注意。
        </div>
      </div>
      <!-- ▲ 複数巨大パッケージ用エクスポート領域 -->
    <div id="linesBox" class="form-container" style="display:none;">
      <h2>Agreement Line（Holdings IQ 拡張列）</h2>
      <div id="loadingMsg"></div>
      <div class="table-wrapper">
        <table id="linesTable">
          <thead>
            <tr>
              <th>情報（処理結果）</th>
              <th>Agreement ID</th>
              <th>Name</th>
              <th>Start Date</th>
              <th>Status</th>
              <th>Entitlement ID</th>
              <th>Reference <span class="small">(VendorID - PackageID - KBID / VendorID - PackageID)</span></th>
              <th>Label</th>
              <th>Provider</th>
              <th>Package Name</th>
              <th>Publication Type</th>
              <th>URL</th>
              <!-- New HIQ enrichment columns -->
              <th>HIQ Provider name</th>
              <th>HIQ Package name</th>
              <th>HIQ Title name</th>
              <th>HIQ Title ID</th>
              <th>HIQ Package ID</th>
              <th>HIQ Provider ID</th>
              <th>HIQ Resource type</th>
              <th>HIQ Managed begin</th>
              <th>HIQ Managed end</th>
              <th>HIQ Custom begin</th>
              <th>HIQ Custom end</th>
              <th>HIQ URL</th>
              <th>HIQ Print ISSN</th>
              <th>HIQ Online ISSN</th>
              <th>HIQ Print ISBN</th>
              <th>HIQ Online ISBN</th>
              <th>HIQ Selected / Not selected</th>
              <th>HIQ Custom label 1</th>
              <th>HIQ Custom label 2</th>
              <th>HIQ Custom label 3</th>
              <th>HIQ Custom label 4</th>
              <th>HIQ Custom label 5</th>
              <th>HIQ Root proxy</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
    <script>
      let okapi = { base:'', tenant:'', token:'' };
      let hiq = { apiKey:'', customerId:'' };
      let selectedAgreementId = '';
      let selectedDetails = null;
      let dtLines = null, dtAgreements = null;
      // 選択切替の競合防止用シーケンス
      let activeAgreementSeq = 0;
      let linesTableTemplateHTML = '';

      // ▼ 複数エクスポートジョブ管理
      // exportJobs[pkgId] = { name, total, jobId, status, link, timer }
      let exportJobs = {};

      const msg = (html, cls='info') => {
        document.getElementById('message').innerHTML = `<div class="${cls}">${html}</div>`;
      };

      function showExportAreaIfNeeded(){
        const area = document.getElementById('exportArea');
        if(!area) return;
        const hasRows = Object.keys(exportJobs).length > 0;
        area.style.display = hasRows ? 'block' : 'none';
      }
      function resetExportArea(){
        exportJobs = {};
        const tbody = document.querySelector('#exportTable tbody');
        if(tbody) tbody.innerHTML = '';
        showExportAreaIfNeeded();
      }

      function ensureExportRow(pkgId, pkgName, total){
        const tableBody = document.querySelector('#exportTable tbody');
        if(!tableBody) return;

        if(!exportJobs[pkgId]){
          exportJobs[pkgId] = { name: pkgName || '', total: Number(total)||0, jobId:null, status:'READY', link:'', timer:null };

          const tr = document.createElement('tr');
          tr.id = `export-row-${pkgId}`;
          tr.innerHTML = `
            <td>${escapeHtml((pkgName||''))}</td>
            <td>${escapeHtml(String(pkgId))}</code></td>
            <td>${escapeHtml(String(total))}</span></td>
            <td>
              <button class="btnStartExport" data-pkgid="${escapeHtml(String(pkgId))}">DL開始</button>
            </td>
            <td id="export-status-${pkgId}" class="small"></td>
            <td id="export-link-${pkgId}"></td>
          `;
          tableBody.appendChild(tr);
        }else{
          exportJobs[pkgId].name = pkgName || exportJobs[pkgId].name;
          exportJobs[pkgId].total = Number(total)||exportJobs[pkgId].total;
          const row = document.getElementById(`export-row-${pkgId}`);
          if(row){
            row.cells[0].innerHTML = `<span class=\"badge\" title=\"${escapeHtml(pkgName||exportJobs[pkgId].name)}\">${escapeHtml((pkgName||exportJobs[pkgId].name).slice(0,120))}</span>`;
            row.cells[2].innerHTML = `<span class=\"badge\">${escapeHtml(String(total))}</span>`;
          }
        }
        showExportAreaIfNeeded();
      }

      function makeExportFileName(baseName){
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        const ts  = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
        const safeBase = (baseName || 'package').replace(/[^a-zA-Z0-9._-]+/g,'_').slice(0,120);
        return `${safeBase}_${ts}`;
      }

      async function startExportForPackage(pkgId){
        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();
        if(!(hiq.apiKey && hiq.customerId)){ msg('HIQ: API Key と Customer ID を入力してください。','error'); return; }

        const job = exportJobs[pkgId];
        if(!job){ msg(`Export: 指定の Package ID が見つかりません: ${pkgId}`,'error'); return; }
        if(job.timer){ msg(`Export: 既に進行中です（Package ${pkgId}）。`,'info'); return; }

        const url = `https://api.ebsco.io/rm/rmaccounts/${encodeURIComponent(hiq.customerId)}/exports`;
        const payload = {
          fileName: makeExportFileName(job.name),
          format: "XLSX",
          packageIds: [ String(pkgId) ],
          type: "STANDARD"
        };

        setRowStatus(pkgId, 'QUEUED（リクエスト中）');
        disableRowButton(pkgId, true);

        try{
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'accept': 'application/json',
              'content-type': 'application/json',
              'x-api-key': hiq.apiKey
            },
            body: JSON.stringify(payload)
          });
          if(!res.ok){
            const t = await res.text().catch(()=> '');
            throw new Error(`Export リクエスト失敗: ${res.status} ${t}`);
          }
          const data = await res.json();
          job.jobId  = data.id || null;
          job.status = data.status || 'QUEUED';
          setRowStatus(pkgId, job.status + '（ジョブ開始）');
          beginPollingForPackage(pkgId);
        }catch(e){
          setRowStatus(pkgId, `ERROR: ${e.message}`);
          disableRowButton(pkgId, false);
        }
      }

      function beginPollingForPackage(pkgId){
        const job = exportJobs[pkgId];
        if(!job || !job.jobId) return;
        clearPollingForPackage(pkgId);
        job.timer = setInterval(()=> pollExportStatusForPackage(pkgId), 5000);
        pollExportStatusForPackage(pkgId);
      }

      function clearPollingForPackage(pkgId){
        const job = exportJobs[pkgId];
        if(job && job.timer){ clearInterval(job.timer); job.timer = null; }
      }

      async function pollExportStatusForPackage(pkgId){
        const job = exportJobs[pkgId];
        if(!job || !job.jobId) return;
        const url = `https://api.ebsco.io/rm/rmaccounts/${encodeURIComponent(hiq.customerId)}/exports/${encodeURIComponent(job.jobId)}`;
        try{
          const res = await fetch(url, { headers: { 'accept':'application/json', 'x-api-key': hiq.apiKey }});
          if(!res.ok){
            const t = await res.text().catch(()=> '');
            throw new Error(`ポーリング失敗: ${res.status} ${t}`);
          }
          const data = await res.json();
          const status = String(data.status || 'UNKNOWN');
          job.status = status;
          const linkObj = Array.isArray(data.links) ? data.links.find(l => l.rel==='download' && l.href) : null;
          job.link = linkObj ? linkObj.href : '';
          setRowStatus(pkgId, status);
          setRowLink(pkgId, job.link);
          if(status === 'COMPLETED'){
            clearPollingForPackage(pkgId);
            disableRowButton(pkgId, false);
            msg(`エクスポート完了（Package ${pkgId}）。リンクからダウンロードできます。`,'success');
          }else if(status === 'FAILED' || status === 'CANCELED'){
            clearPollingForPackage(pkgId);
            disableRowButton(pkgId, false);
            msg(`エクスポートが ${status} になりました（Package ${pkgId}）。再試行してください。`,'error');
          }
        }catch(e){
          clearPollingForPackage(pkgId);
          disableRowButton(pkgId, false);
          setRowStatus(pkgId, `ERROR: ${e.message}`);
        }
      }

      function setRowStatus(pkgId, text){
        const cell = document.getElementById(`export-status-${pkgId}`);
        if(cell) cell.innerHTML = escapeHtml(text||'');
      }
      function setRowLink(pkgId, href){
        const cell = document.getElementById(`export-link-${pkgId}`);
        if(!cell) return;
        if(href){
          const esc = escapeHtml(href);
          cell.innerHTML = `<a href="${esc}" target="_blank" rel="noopener noreferrer">エクスポートファイルをダウンロード</a>`;
        }else{
          cell.textContent = '';
        }
      }
      function disableRowButton(pkgId, disabled){
        const btn = document.querySelector(`.btnStartExport[data-pkgid="${cssEscape(String(pkgId))}"]`);
        if(btn) btn.disabled = !!disabled;
      }

      // --- Login (Okapi) ---
      async function login(){
        const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
        const tenant = document.getElementById('tenant').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        hiq.apiKey = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

        if(!baseUrl || !tenant || !username || !password){
          msg('Okapi: Base URL / Tenant / Username / Password を入力してください。','error');
          return;
        }

        msg('ログイン中…');
        try{
          const res = await fetch(`${baseUrl}/authn/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-okapi-tenant": tenant },
            body: JSON.stringify({ username, password })
          });
          if(res.status !== 201){ msg(`認証失敗: ${res.status}`, 'error'); return; }
          const token = res.headers.get('x-okapi-token');
          if(!token){ msg('トークンがヘッダーにありません（Access-Control-Expose-Headers 設定要）。', 'error'); return; }
          okapi = { base: baseUrl, tenant, token };
          msg('ログイン成功。次に「Agreement一覧を取得」ボタンを押してください。', 'success');
          document.getElementById('btnReloadAgreements').disabled = false;
          document.getElementById('btnDownloadCSV').disabled = true;
        }catch(e){ msg('通信エラー: ' + e.message, 'error'); }
      }

      // --- Agreements list / details ---
      async function loadAgreements(){
        if(!okapi.token){ msg('先にログインしてください。','error'); return; }
        msg('Agreement一覧を取得中…');
        try{
          const res = await fetch(`${okapi.base}/erm/sas?sort=name%3Basc&stats=true&page=1&perPage=100`, {
            headers: { "x-okapi-token": okapi.token }
          });
          if(!res.ok){ msg('Agreement 取得失敗: ' + res.status, 'error'); return; }
          const data = await res.json();
          const agreements = data.results || [];
          document.getElementById('agreementsBox').style.display = 'block';
          renderAgreementsTable(agreements);
          msg(`Agreement 取得完了（${agreements.length}件）`, 'success');
        }catch(e){ msg('通信エラー: ' + e.message, 'error'); }
      }

      function renderAgreementsTable(items){
        const tbody = document.querySelector('#agreementsTable tbody');
        tbody.innerHTML = '';
        items.forEach(a => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><button class="detail-btn" data-id="${a.id}">明細取得</button></td>
            <td>${escapeHtml(a.id)}</td>
            <td>${escapeHtml(a.name || '')}</td>
            <td>${escapeHtml((a.startDate || '').slice(0,10))}</td>
            <td>${escapeHtml((a.agreementStatus && a.agreementStatus.label) || '')}</td>
          `;
          tbody.appendChild(tr);
        });
        if(dtAgreements){ dtAgreements.destroy(); }
        dtAgreements = $('#agreementsTable').DataTable({
          paging:false, searching:true, ordering:true, info:false,
          scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 }, scrollY:"260px"
        });
        dtAgreements.columns.adjust();
      }

      async function onPickAgreement(agreementId){
        // 新しい選択開始: 競合回避のためシーケンスを進める
        activeAgreementSeq++;
        const seq = activeAgreementSeq;
        selectedAgreementId = agreementId;
        // 行ハイライト処理
        const allRows = document.querySelectorAll('#agreementsTable tbody tr');
        allRows.forEach(tr => tr.classList.remove('selected-row'));
        const btn = document.querySelector(`.detail-btn[data-id="${agreementId}"]`);
        if (btn) {
          const row = btn.closest('tr');
        if (row) row.classList.add('selected-row');
        }

        // 旧表示・ジョブをクリア
        resetLinesUI();
        resetExportArea();
        document.getElementById('loadingMsg').textContent = '';
        msg(`Agreement(${escapeHtml(agreementId)}) の読み込みを開始しました…`);

        await fetchAgreementDetails(agreementId, seq);
        await fetchEntitlements(agreementId, seq);
      }

      async function fetchAgreementDetails(id, seq){
        msg('Agreement メタデータ取得中…');
        const res = await fetch(`${okapi.base}/erm/sas/${encodeURIComponent(id)}`, {
          headers: { "x-okapi-token": okapi.token }
        });
        if(!res.ok){ msg('Agreement 詳細取得失敗: ' + res.status, 'error'); return; }
        const details = await res.json();
        if(seq !== activeAgreementSeq) return;
        msg('Agreement メタデータ取得完了', 'success');
      }

      // ========== Agreement Lines 取得（HIQ 拡張付き） ==========
      async function fetchEntitlements(agreementId, seq){
        const linesBox = document.getElementById('linesBox');
        if (linesBox) linesBox.style.display = 'block';

        const loading = document.getElementById('loadingMsg');
        loading.innerHTML = '<div class="info">Agreement Line（HIQ）問い合わせ中…</div>';
        msg('Agreement Line 取得中', 'info');

        const perPage = 100;
        let page = 1, totalPages = 1;
        const all = [];
        try{
          let url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
          let res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
          if(!res.ok){ loading.textContent=''; msg('Entitlements 取得失敗: ' + res.status, 'error'); return; }
          let data = await res.json();
          if(seq !== activeAgreementSeq) return;
          totalPages = data.totalPages || 1;
          all.push(...(data.results||[]));
          for(page=2; page<=totalPages; page++){
            loading.textContent = `Agreement Line（HIQ）問い合わせ中… (${page}/${totalPages})`;
            url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
            res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
            if(!res.ok){ loading.textContent=''; msg('Entitlements 取得失敗: ' + res.status, 'error'); return; }
            data = await res.json();
            if(seq !== activeAgreementSeq) return;
            all.push(...(data.results||[]));
          }

          hiq.apiKey = document.getElementById('hiqApiKey').value.trim();
          hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

          if(!(hiq.apiKey && hiq.customerId)){
            if(seq !== activeAgreementSeq) { loading.textContent=''; return; }
            renderLinesTable(all);
            loading.textContent='';
            msg(`Agreement Line 取得完了（${all.length}件, HIQ拡張なし）`, 'success');
            document.getElementById('btnDownloadCSV').disabled = all.length === 0;
            return;
          }

          const titleItems = [];
          const packageItems = [];
          for(const e of all){
            const a = getAuthority(e);
            if(a === 'EKB-PACKAGE') packageItems.push(e); else titleItems.push(e);
          }

          msg(`HIQ: パッケージ展開中…（${packageItems.length}件のパッケージ）`);
          loading.innerHTML = '<div class="info">HIQパッケージ展開中…</div>';
          const packageRows = await expandPackagesToRows(packageItems, seq);
          if(seq !== activeAgreementSeq) { loading.textContent=''; return; }

          const rows = [...titleItems, ...packageRows];
          if(seq !== activeAgreementSeq) { loading.textContent=''; return; }
          renderLinesTable(rows);

          // TITLE は描画後に非同期で埋める
          loading.textContent = 'HIQ タイトル詳細の取得中…';
          await enrichWithHoldingsIQ(titleItems, seq);

          loading.textContent='';
          msg(`Agreement Line 取得完了（TITLE: ${titleItems.length}件, PACKAGE 展開: ${packageRows.length}行, 合計: ${rows.length}行）`, 'success');
          document.getElementById('btnDownloadCSV').disabled = rows.length === 0;
        }catch(e){ console.error(e); loading.textContent=''; msg('通信エラー: ' + e.message, 'error'); }
      }

      function renderLinesTable(items){
        const table = document.getElementById('linesTable'); // ← 差し戻し後の新しい要素
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        const d = selectedDetails || {};
        const name = d.name || '';
        const start = (d.startDate || '').slice(0,10);
        const status = (d.agreementStatus && d.agreementStatus.label) || '';

        items.forEach(e => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-entitlement-id', e.id || '');
          const hiqData = e._hiq || null;

          // --- 左端の情報列 ---
          let infoLabel = '';
          try {
            if (e._skipLarge) {
              infoLabel = '要DL';
            } else if (e._error) {
              infoLabel = 'Error';
            }else {
              infoLabel = '';
            }
          } catch(_) { infoLabel = 'Error'; }

          const cells = [
            infoLabel,
            safe(e.owner?.id || selectedAgreementId || ''),
            safe(name),
            safe(start),
            safe(status),
            safe(e.id||''),
            safe(e.reference||''),
            safe(e.reference_object && e.reference_object.label || ''),
            safe(e.reference_object && e.reference_object.provider || ''),
            safe(e.reference_object && e.reference_object.packageData && e.reference_object.packageData.name || ''),
            safe(e.reference_object && e.reference_object.publicationType || ''),
            linkCell(e.reference_object && e.reference_object.url || ''),
            // --- HIQ columns ---
            hiqData ? hiqData.providerName : '',
            hiqData ? hiqData.packageName : '',
            hiqData ? hiqData.titleName : '',
            hiqData ? hiqData.titleId : '',
            hiqData ? hiqData.packageId : '',
            hiqData ? hiqData.providerId : '',
            hiqData ? hiqData.resourceType : '',
            hiqData ? hiqData.coverageManagedBegin : '',
            hiqData ? hiqData.coverageManagedEnd   : '',
            hiqData ? hiqData.coverageCustomBegin  : '',
            hiqData ? hiqData.coverageCustomEnd    : '',
            hiqData ? linkCell(hiqData.url)        : '',
            hiqData ? hiqData.printIssn : '',
            hiqData ? hiqData.onlineIssn : '',
            hiqData ? hiqData.printIsbn : '',
            hiqData ? hiqData.onlineIsbn : '',
            hiqData ? hiqData.selected : '',
            hiqData ? hiqData.label1 : '',
            hiqData ? hiqData.label2 : '',
            hiqData ? hiqData.label3 : '',
            hiqData ? hiqData.label4 : '',
            hiqData ? hiqData.label5 : '',
            hiqData ? hiqData.rootProxy : ''
          ];

          // link columns: Agreement ref URL (11) and HIQ URL (23)
          tr.innerHTML = cells.map((cell,i)=> (i===11 || i===23) ? `<td>${cell}</td>` : `<td>${escapeHtml(cell)}</td>`).join('');
          tbody.appendChild(tr);
        });
        dtLines = $("#linesTable").DataTable({
          paging:false, searching:true, ordering:true, info:false,
          scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:5 }, /* 情報列を含めて左固定5列 */
          scrollY:"360px"
        });
        dtLines.columns.adjust();
      }

      async function enrichWithHoldingsIQ(items, seq){
        if(!items || !items.length) return;
        const capturedSeq = seq;

        const headers = { accept: 'application/json', 'x-api-key': hiq.apiKey };
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getTitleDetail.php';

        const concurrency = 6;
        const total = items.length;
        let done = 0;
        const queue = [...items];
        const workers = Array.from({ length: concurrency }, () => worker());

        async function worker(){
          while (queue.length){
            const e = queue.shift();
            if (!e) break;
            if (getAuthority(e) === 'EKB-PACKAGE') continue;
            if (capturedSeq !== activeAgreementSeq) return; // 途中切替

            const parsed = parseReference3((e.reference || '').trim());
            if (!parsed) continue;
            const { packageId, kbId } = parsed;
            const url = `${base}?custid=${hiq.customerId}&packageid=${packageId}&kbid=${kbId}`;
            try {
              const res = await fetch(url, { headers });
              if (!res.ok) { if(capturedSeq===activeAgreementSeq) updateRowStatus(e.id || '', 'Error'); continue; }

              const titleObj = await res.json();
              if (capturedSeq !== activeAgreementSeq) return;
              if (titleObj) {
                updateRowWithHIQ(e.id || '', hiqFromTitle(titleObj));
              }
            } catch (_) { if(capturedSeq===activeAgreementSeq) updateRowStatus(e.id || '', 'Error'); }
            finally {
              done++; const loading = document.getElementById('loadingMsg');
              if(loading && capturedSeq===activeAgreementSeq) loading.textContent = `HIQ タイトル詳細の取得中… (${done}/${total})`;
            }
          }
        }
        await Promise.all(workers);
        const loading = document.getElementById('loadingMsg');
        if(loading && capturedSeq===activeAgreementSeq) loading.textContent = '';
      }

      async function expandPackagesToRows(packageItems, seq){
        if(!packageItems.length) return [];
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getPackageTitles.php';
        const headers = { 'accept':'application/json', 'x-api-key': hiq.apiKey };

        const concurrency = 3;
        const queue = [...packageItems];
        const out = [];

        async function worker(){
          while(queue.length){
            const e = queue.shift();
            if(!e) break;
            if(seq !== activeAgreementSeq) return; // 途中切替
            const p = parseReference2((e.reference || '').trim());
            if(!p) { out.push(e); continue; }
            const { vendorId, packageId } = p;

            let page = 1, count = 100, safety = 2000;
            let total = 0;
            while (safety-- > 0){
              const url = `${base}?account=${hiq.customerId}&vendor=${vendorId}&package=${packageId}&count=${count}&offset=${page}&orderby=titlename&searchfield=titlename`;
              try{
                const res = await fetch(url, { headers });
                if(!res.ok) { out.push({ ...e, _error:true }); break; }
                const data = await res.json();
                const titles = Array.isArray(data.titles) ? data.titles : [];
                total = Number(data.totalResults || 0);

                // 1ページ目で総件数チェック。1万件以上ならエクスポート一覧へ、展開スキップ
                if(page === 1 && total >= 10000){
                  const pkgName = (
                    e?.reference_object?.label ||
                    e?.reference_object?.packageData?.name ||
                    e?._hiq?.packageName ||
                    ''
                  );
                  ensureExportRow(packageId, pkgName, total);
                  out.push({ ...e, _status:'要DL', _skipLarge:true });
                  break;
                }

                for(const t of titles){
                  out.push({ ...e, _hiq: hiqFromTitle(t)});
                }

                // 次ページ判定（ページ番号方式）
                if(titles.length < count) break; // 最終ページ
                const maxPage = total ? Math.ceil(total / count) : Infinity;
                page++;
                if(page > maxPage) break;
              }catch(_){ out.push({ ...e, _error:true }); break; }
            }
          }
        }

        const workers = Array.from({length: concurrency}, () => worker());
        await Promise.all(workers);
        if(seq !== activeAgreementSeq) return out;

        showExportAreaIfNeeded();
        return out;
      }

      function hiqFromTitle(t){
        const cr = Array.isArray(t.customerResourcesList) && t.customerResourcesList.length ? t.customerResourcesList[0] : {};
        const ids = splitIdentifiers(t.identifiersList || []);
        const { begin: managedBegin, end: managedEnd } = firstCoverage(cr.managedCoverageList);
        const { begin: customBegin,  end: customEnd  } = firstCoverage(cr.customCoverageList);

        return {
          providerName: cr?.vendorName ?? t?.vendorName ?? '',
          packageName:  cr?.packageName  ?? t?.packageName  ?? '',
          titleName: t.titleName || '',
          titleId:   String(t?.titleId ?? t?.kbid ?? t?.kbId ?? ''),
          packageId: String(cr?.packageId ?? t?.listId ?? ''),
          providerId: String(cr?.vendorId ?? t?.vendorId ?? ''),
          resourceType: t.pubType || '',
          coverageManagedBegin: managedBegin,
          coverageManagedEnd:   managedEnd,
          coverageCustomBegin:  customBegin,
          coverageCustomEnd:    customEnd,
          url: cr?.url ?? t?.url ?? '',
          printIssn: ids.printIssn,
          onlineIssn: ids.onlineIssn,
          printIsbn: ids.printIsbn,
          onlineIsbn: ids.onlineIsbn,
          selected: cr && cr.isSelected ? 'Selected' : 'Not selected',
          label1: cr?.userDefinedField1 ?? t?.userDefinedField1 ?? '',
          label2: cr?.userDefinedField2 ?? t?.userDefinedField2 ?? '',
          label3: cr?.userDefinedField3 ?? t?.userDefinedField3 ?? '',
          label4: cr?.userDefinedField4 ?? t?.userDefinedField4 ?? '',
          label5: cr?.userDefinedField5 ?? t?.userDefinedField5 ?? '',
          rootProxy: cr && cr.proxy && cr.proxy.proxiedUrl ? cr.proxy.proxiedUrl : ''
        };
      }

      function firstCoverage(list){
        try{
          const c = Array.isArray(list) && list.length ? list[0] : null;
          return {
            begin: (c && c.beginCoverage) || '',
            end:   (c && c.endCoverage)   || ''
          };
        }catch(_){ return { begin:'', end:'' }; }
      }

      function splitIdentifiers(list){
        const out = { printIssn:'', onlineIssn:'', printIsbn:'', onlineIsbn:'' };
        try{
          const bySource = { 'Print ISSN': [], 'Online ISSN': [], 'Print ISBN': [], 'Online ISBN': [] };
          (list||[]).forEach(x => { if(!x || !x.id) return; if(bySource[x.source]) bySource[x.source].push(String(x.id)); });
          out.printIssn = bySource['Print ISSN'].join('; ');
          out.onlineIssn = bySource['Online ISSN'].join('; ');
          out.printIsbn = bySource['Print ISBN'].join('; ');
          out.onlineIsbn = bySource['Online ISBN'].join('; ');
        }catch(_){ /* noop */ }
        return out;
      }

      function updateRowWithHIQ(entitlementId, hiqObj){
        const tr = document.querySelector(`tr[data-entitlement-id="${cssEscape(entitlementId)}"]`);
        if(!tr) return;
        const cells = tr.cells;
        const baseIndex = 12; // 情報列追加により +1
        const setCell = (idx, val, isLink=false) => {
          if(!cells[idx]) return;
          cells[idx].innerHTML = isLink && val ? `<a href="${escapeHtml(val)}" target="_blank" rel="noopener noreferrer">${escapeHtml(val)}</a>` : escapeHtml(val||'');
        };
        setCell(baseIndex + 0,  hiqObj.providerName);
        setCell(baseIndex + 1,  hiqObj.packageName);
        setCell(baseIndex + 2,  hiqObj.titleName);
        setCell(baseIndex + 3,  hiqObj.titleId);
        setCell(baseIndex + 4,  hiqObj.packageId);
        setCell(baseIndex + 5,  hiqObj.providerId);
        setCell(baseIndex + 6,  hiqObj.resourceType);
        setCell(baseIndex + 7,  hiqObj.coverageManagedBegin);
        setCell(baseIndex + 8,  hiqObj.coverageManagedEnd);
        setCell(baseIndex + 9,  hiqObj.coverageCustomBegin);
        setCell(baseIndex + 10, hiqObj.coverageCustomEnd);
        setCell(baseIndex + 11, hiqObj.url, true);
        setCell(baseIndex + 12, hiqObj.printIssn);
        setCell(baseIndex + 13, hiqObj.onlineIssn);
        setCell(baseIndex + 14, hiqObj.printIsbn);
        setCell(baseIndex + 15, hiqObj.onlineIsbn);
        setCell(baseIndex + 16, hiqObj.selected);
        setCell(baseIndex + 17, hiqObj.label1);
        setCell(baseIndex + 18, hiqObj.label2);
        setCell(baseIndex + 19, hiqObj.label3);
        setCell(baseIndex + 20, hiqObj.label4);
        setCell(baseIndex + 21, hiqObj.label5);
        setCell(baseIndex + 22, hiqObj.rootProxy);
      }

      function updateRowStatus(entitlementId, text){
        const tr = document.querySelector(`tr[data-entitlement-id="${cssEscape(entitlementId)}"]`);
        if(!tr) return;
        const cell = tr.cells[0]; // 一番左の 情報（処理結果）
        if(cell) cell.textContent = text || '';
      }

      function safe(v){ return v==null? '': String(v); }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function cssEscape(s){ return String(s).replace(/["\\#.;:,\[\]\(\)\s]/g, '\\$&'); }
      function linkCell(u){ if(!u) return ''; const esc = escapeHtml(String(u)); return `<a href="${esc}" target="_blank" rel="noopener noreferrer">${esc}</a>`; }

      function getAuthority(e){
        const a = (e.resource && e.resource.authority) || e.authority || (e.reference_object && e.reference_object.authority);
        if(a) return a;
        const ref = (e.reference || '').trim();
        if(parseReference3(ref)) return 'EKB-TITLE';
        if(parseReference2(ref)) return 'EKB-PACKAGE';
        return '';
      }
      function parseReference3(ref){ // 36 - 1515 - 968431
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2], kbId: m[3] };
      }
      function parseReference2(ref){ // 36 - 1515
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2] };
      }

      document.getElementById('btnLogin').addEventListener('click', login);
      document.getElementById('btnReloadAgreements').addEventListener('click', loadAgreements);
      document.getElementById('btnDownloadCSV').addEventListener('click', downloadCSV);

      // Agreement一覧の「明細取得」ボタン
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.detail-btn');
        if(btn){
          const id = btn.getAttribute('data-id') || '';
          if(id){ onPickAgreement(id); }
          else { msg('Agreement ID を取得できませんでした。','error'); }
        }
      });

      // エクスポート「DL開始」ボタン
      document.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('.btnStartExport');
        if(btn){
          const pkgId = btn.getAttribute('data-pkgid');
          startExportForPackage(pkgId);
        }
      });

      // --- CSV Export (Agreement Lines + HIQ columns) ---
      function downloadCSV(){
        const table = document.getElementById('linesTable');
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr =>
          Array.from(tr.cells).map((td,i)=>{
            let t = (i===11 || i===23) ? td.querySelector('a')?.getAttribute('href')||'' : td.innerText;
            if(/[",\n]/.test(t)) t = '"' + t.replace(/"/g,'""') + '"';
            return t;
          }).join(',')
        );
        if(!rows.length){ alert('出力するデータがありません'); return; }
        const headers = [
          '情報（処理結果）','Agreement ID','Name','Start Date','Status','Entitlement ID','Reference','Label','Provider','Package Name','Publication Type','URL',
          'HIQ Provider name','HIQ Package name','HIQ Title name','HIQ Title ID','HIQ Package ID','HIQ Provider ID','HIQ Resource type','HIQ Managed begin','HIQ Managed end','HIQ Custom begin','HIQ Custom end','HIQ URL','HIQ Print ISSN','HIQ Online ISSN','HIQ Print ISBN','HIQ Online ISBN','HIQ Selected / Not selected','HIQ Custom label 1','HIQ Custom label 2','HIQ Custom label 3','HIQ Custom label 4','HIQ Custom label 5','HIQ Root proxy'
        ];
        const csv = "\uFEFF" + [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const now = new Date(), pad=n=>String(n).padStart(2,'0');
        const ts = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const baseName = (selectedDetails && selectedDetails.name) ? selectedDetails.name.replace(/[^a-zA-Z0-9_-]+/g,'_') : (selectedAgreementId||'export');
        a.href = url; a.download = `agreement_lines_hiq_${baseName}_${ts}.csv`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function resetLinesUI(){
      // 1) いまのテーブル&ラッパを把握
      const currentTable = document.getElementById('linesTable');
      if(!currentTable) return;
      const wrapper = currentTable.closest('.table-wrapper') || currentTable.parentElement;

      // 2) 初回だけ、元のテーブル骨組み（thead/空tbody）のHTMLを保存
      if(!linesTableTemplateHTML){
        linesTableTemplateHTML = currentTable.outerHTML;
      }

      // 3) DataTable を完全破棄（DOMラッパも含めて）
      try{
        if ($.fn.DataTable.isDataTable(currentTable)) {
          $(currentTable).DataTable().destroy(true); // true: ラッパ含めて削除
        }
      }catch(_){ /* noop */ }
      dtLines = null;

      // 4) 元のテーブル骨組みに差し戻す（空の #linesTable が復活）
      if(wrapper){
        wrapper.innerHTML = linesTableTemplateHTML;
      }
      // 表示枠を隠す（初期状態に戻す）
      const linesBox = document.getElementById('linesBox');
      if (linesBox) linesBox.style.display = 'none';
}

    </script>