<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AgreementLines (+Package Info auto-load)</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css"/>
    <style>
      #agreementsTable tbody tr.selected-row td {background-color: #fff3cd !important;}
      body{font-family:Arial, sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f5f5f5;}
      .form-container{margin:20px 0;padding:20px;border-radius:8px;background:white;box-shadow:0 2px 4px rgba(0,0,0,.1);} 
      .head-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
      .head-row h2{margin:0}
      label{display:block;margin:10px 0;font-size:14px;}
      input[type="text"],input[type="password"]{padding:10px;width:100%;max-width:520px;box-sizing:border-box;margin-top:5px;}
      button{padding:10px 20px;margin-top:10px;margin-right:10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}
      button:disabled{background:#ccc;cursor:not-allowed;}
      button:hover:not(:disabled){background:#0056b3;}
      .table-wrapper{overflow-x:auto;}
      table{border-collapse:collapse;margin-top:20px;width:100%;background:white;}
      th,td{border:1px solid #ddd;padding:8px;vertical-align:top;}
      th{background:#f8f8f8;}
      .success{color:#155724;background:#d4edda;padding:10px;margin:10px 0;border-radius:4px;}
      .error{color:#721c24;background:#f8d7da;padding:10px;margin:10px 0;border-radius:4px;}
      .info{color:#004085;background:#cce5ff;padding:10px;margin:10px 0;border-radius:4px;}
      .subtle{color:#555;font-size:14px;}
      .badge{display:inline-block;background:#eef2ff;color:#334;border:1px solid #ccd;padding:2px 8px;border-radius:999px;font-size:12px;}
      .small{font-size:12px;color:#666;}
      code.k{background:#f1f1f1;padding:1px 4px;border-radius:4px;}
      #loadingMsg{margin:10px 0;font-size:14px;color:#555;}
      /* DataTables 幅計算の安定化 */
      table.dataTable { border-collapse: separate !important; border-spacing: 0 !important; }
      #linesTable th, #linesTable td { white-space: nowrap; }
      .dataTables_wrapper .dataTables_scrollHead, 
      .dataTables_wrapper .dataTables_scrollBody { overflow: auto; }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>AgreementLines 取得ツール</h2>
      <label>Okapi Base URL:
        <input type="text" id="baseUrl" value="https://folio-snapshot-2-okapi.dev.folio.org" />
      </label>
      <label>Tenant:
        <input type="text" id="tenant" value="diku" />
      </label>
      <label>Username:
        <input type="text" id="username" value="diku_admin" />
      </label>
      <label>Password:
        <input type="password" id="password" value="admin" />
      </label>
      <hr class="small"/>
      <div class="small">▼契約明細（Agreement Line）のみ取得する場合は不要です。パッケージ情報も同時に自動取得・表示したい場合やパッケージのダウンロードをする場合は入力してください。</div>
       <label>Customer ID（任意）:
        <input type="text" id="hiqCustomerId" placeholder="例: s1234567" />
      </label>
      <label>Holdings IQ API Key（任意）:
        <input type="text" id="hiqApiKey" placeholder="例: evasfSEFg234..." />
      </label>
      <button id="btnLogin">ログイン</button>
      <button id="btnReloadAgreements" disabled>Agreement一覧を取得</button>
      <div id="message" class="small"></div>
    </div>

    <div class="form-container" id="agreementsBox" style="display:none;">
      <h2>契約（Agreement）一覧</h2>
      <div class="table-wrapper">
        <table id="agreementsTable">
          <thead>
            <tr>
              <th>明細取得</th>
              <th>ID</th>
              <th>Name</th>
              <th>Start Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="linesBox" class="form-container" style="display:none;">
      <div class="head-row">
        <h2>契約明細（Agreement Line）</h2>
        <button id="btnDownloadCSVLines" disabled>CSVダウンロード（明細）</button>
      </div>
      <div class="small">Reference: VendorID - PackageID - KBID / VendorID - PackageID</div>
      <div id="loadingMsg"></div>
      <div class="table-wrapper">
        <table id="linesTable">
          <thead>
            <tr>
              <th>Level</th>
              <th>Entitlement ID</th>
              <th>Reference</th>
              <th>Label</th>
              <th>Provider</th>
              <th>Package Name</th>
              <th>Publication Type</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ▼ パッケージ情報（明細取得と同時に自動取得） -->
    <div id="packageInfoBox" class="form-container" style="display:none;">
      <h2>パッケージ情報</h2>
      <div id="packageInfoMsg" class="small"></div>
      <!-- 🔴 追加：個別エラーの表示領域（累積表示） -->
      <div id="packageInfoErr" class="small"></div>
      <div class="table-wrapper">
        <table id="packageInfoTable">
          <thead>
            <tr>
              <th>操作</th>
              <th>Vendor ID</th>
              <th>Package ID</th>
              <th>Package name</th>
              <th>Vendor name</th>
              <th>Selected count</th>
              <th>Title count</th>
              <th>Package free access</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- ▲ パッケージ情報 -->

    <!-- ▼ パッケージのタイトル一覧（パッケージ情報の下に表示） -->
    <div id="packageTitlesBox" class="form-container" style="display:none;">
      <div class="head-row">
        <h2 id="packageTitlesHeading">パッケージ内タイトル一覧</h2>
        <button id="btnDownloadCSVTitles" disabled>CSVダウンロード（タイトル）</button>
      </div>
      <div id="packageTitlesMsg" class="small"></div>
      <div class="table-wrapper">
        <table id="packageTitlesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title name</th>
              <th>Title ID</th>
              <th>Resource type</th>
              <th>Selected</th>
              <th>URL</th>
              <th>Print ISSN</th>
              <th>Online ISSN</th>
              <th>Print ISBN</th>
              <th>Online ISBN</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- ▲ パッケージのタイトル一覧 -->

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
    <script>
      // ▼ タイトル一覧用キャッシュ / DataTable
      let pkgTitlesCache = new Map(); // packageId -> { list:[], total:number, name:string }
      let dtPkgTitles = null;

      // ✅ 追加：現在のタイトル一覧対象（全件CSV出力で使用）
      let currentPackageIdForTitles = '';
      let currentPackageNameForTitles = '';

      function showPackageTitlesBox(show){
        const box = document.getElementById('packageTitlesBox');
        if (box) box.style.display = show ? 'block' : 'none';
      }
      function setPackageTitlesMsg(html, cls='info'){
        const el = document.getElementById('packageTitlesMsg');
        if (el) el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }
      function resetPackageTitlesUI(){
        const table = document.getElementById('packageTitlesTable');
        if(!table) return;
        try{
          if ($.fn.DataTable.isDataTable(table)) {
            $(table).DataTable().destroy(true);
          }
        }catch(_){ }
        // テーブル骨組み再生成
        const wrapper = table.closest('.table-wrapper');
        if(wrapper){
          wrapper.innerHTML = `
            <table id="packageTitlesTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Title name</th>
                  <th>Title ID</th>
                  <th>Resource type</th>
                  <th>Selected</th>
                  <th>URL</th>
                  <th>Print ISSN</th>
                  <th>Online ISSN</th>
                  <th>Print ISBN</th>
                  <th>Online ISBN</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>`;
        }
        dtPkgTitles = null;
        setPackageTitlesMsg('');
        showPackageTitlesBox(false);
        const b = document.getElementById('btnDownloadCSVTitles');
        if (b) b.disabled = true;
        currentPackageIdForTitles = '';
        currentPackageNameForTitles = '';
      }

      // ▼ パッケージ情報 UI
      function showPackageInfoBox(show){
        const box = document.getElementById('packageInfoBox');
        if (box) box.style.display = show ? 'block' : 'none';
      }
      function setPackageInfoMsg(html, cls='info'){
        const el = document.getElementById('packageInfoMsg');
        if (el) el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }
      // 🔴 追加：個別エラーを追記表示する
      function appendPackageInfoErr(html){
        const el = document.getElementById('packageInfoErr');
        if(!el) return;
        const div = document.createElement('div');
        div.className = 'error';
        div.innerHTML = html;
        el.appendChild(div);
      }
      function resetPackageInfoUI(){
        const table = document.getElementById('packageInfoTable');
        if(!table) return;
        const tbody = table.querySelector('tbody');
        if(tbody) tbody.innerHTML = '';
        setPackageInfoMsg('');
        const err = document.getElementById('packageInfoErr');
        if(err) err.innerHTML = '';
        showPackageInfoBox(false);
      }

      // --- Agreements table reset (rebuild skeleton & destroy DataTable) ---
      function resetAgreementsUI(){
        const currentTable = document.getElementById('agreementsTable');
        if(!currentTable) return;
        const wrapper = currentTable.closest('.table-wrapper') || currentTable.parentElement;
        try{
          if ($.fn.DataTable && $.fn.DataTable.isDataTable(currentTable)) {
            $(currentTable).DataTable().destroy(true);
          }
        }catch(_){ }
        if(!agreementsTableTemplateHTML){
          agreementsTableTemplateHTML = currentTable.outerHTML;
        }
        if(wrapper){
          wrapper.innerHTML = agreementsTableTemplateHTML;
        }
      }
      // Agreements行をDataTablesに入れやすい形へ
function agreementRowFromItem(a){
  return [
    `<button class="detail-btn" data-id="${escapeHtml(String(a.id))}">明細取得</button>`,
    escapeHtml(String(a.id)),
    escapeHtml(a.name || ''),
    escapeHtml((a.startDate || '').slice(0,10)),
    escapeHtml((a.agreementStatus && a.agreementStatus.label) || '')
  ];
}

  // Agreements用 DataTable 初期化（空で立ち上げる）
  function initAgreementsTable(){
    const tbody = document.querySelector('#agreementsTable tbody');
    if (tbody) tbody.innerHTML = '';
    if (dtAgreements) { dtAgreements.destroy(); }
    dtAgreements = $('#agreementsTable').DataTable({
      paging:false, searching:true, ordering:true, info:false,
      scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 }, scrollY:"260px",
      deferRender:true
    });
    dtAgreements.columns.adjust();
  }

  // ページで取得した分を都度追加
  function appendAgreementsRows(items){
    if (!dtAgreements) initAgreementsTable();
    const rows = (items || []).map(agreementRowFromItem);
    if (rows.length) {
      dtAgreements.rows.add(rows).draw(false);
    }
  }

      // ▼ Okapi / 状態
      let okapi = { base:'', tenant:'', token:'' };
      let hiq = { apiKey:'', customerId:'' }; // パッケージ詳細・タイトル一覧取得に使用
      let selectedAgreementId = '';
      let selectedDetails = null;
      let dtLines = null, dtAgreements = null;
      let activeAgreementSeq = 0;
      let linesTableTemplateHTML = '';
      let agreementsTableTemplateHTML = '';

      const msg = (html, cls='info') => {
        document.getElementById('message').innerHTML = `<div class="${cls}">${html}</div>`;
      };

      function setLinesMsg(html, cls='info'){
        const el = document.getElementById('loadingMsg');
        if (!el) return;
        el.innerHTML = html ? `<div class="${cls}">${html}</div>` : '';
      }

      // --- Login (Okapi) ---
      async function login(){
        const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
        const tenant = document.getElementById('tenant').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        hiq.apiKey = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

        if(!baseUrl || !tenant || !username || !password){
          msg('Okapi: Base URL / Tenant / Username / Password を入力してください。','error');
          return;
        }

        msg('ログイン中…');
        try{
          const res = await fetch(`${baseUrl}/authn/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-okapi-tenant": tenant },
            body: JSON.stringify({ username, password })
          });
          if(res.status !== 201){ msg(`認証失敗: ${res.status}`, 'error'); return; }
          const token = res.headers.get('x-okapi-token');
          if(!token){ msg('トークンがヘッダーにありません（Access-Control-Expose-Headers 設定要）。', 'error'); return; }
          okapi = { base: baseUrl, tenant, token };
          msg('ログイン成功。次に「Agreement一覧を取得」ボタンを押してください。', 'success');
          document.getElementById('btnReloadAgreements').disabled = false;
          const b = document.getElementById('btnDownloadCSVLines');
          if (b) b.disabled = true;
        }catch(e){ msg('通信エラー: ' + e.message, 'error'); }
      }

      // --- Agreements list / details ---
      // --- Agreements list / details ---
async function loadAgreements(){
  if(!okapi.token){ msg('先にログインしてください。','error'); return; }

  msg('Agreement一覧を取得中…');
  try{
    const perPage = 20;                  // ← ここを20に
    let page = 1, totalPages = 1;
    let totalRecords = null;
    let fetched = 0;

    const baseUrl = `${okapi.base}/erm/sas?sort=name%3Basc&stats=true&perPage=${perPage}`;

    // UI準備：テーブルを空で立ち上げ、すぐ表示
    document.getElementById('agreementsBox').style.display = 'block';
    resetAgreementsUI();
    initAgreementsTable();

    // 1ページ目
    let res = await fetch(`${baseUrl}&page=${page}`, { headers: { 'x-okapi-token': okapi.token } });
    if(!res.ok){ msg('Agreement 取得失敗: ' + res.status, 'error'); return; }
    let data = await res.json();

    totalPages = data.totalPages || 1;
    totalRecords = (typeof data.totalRecords === 'number'
                   ? data.totalRecords
                   : (typeof data.total === 'number' ? data.total : null));

    const firstChunk = data.results || [];
    appendAgreementsRows(firstChunk);
    fetched += firstChunk.length;

    msg(`Agreement一覧を取得中… ページ ${page}/${totalPages} ・ 取得 ${fetched}${totalRecords!=null?`/${totalRecords}`:''}`, 'info');

    // 2ページ目以降：取得しながら都度追加＋進捗更新
    for(page = 2; page <= totalPages; page++){
      res = await fetch(`${baseUrl}&page=${page}`, { headers: { 'x-okapi-token': okapi.token } });
      if(!res.ok){ msg('Agreement 取得失敗: ' + res.status, 'error'); return; }
      data = await res.json();

      const chunk = data.results || [];
      appendAgreementsRows(chunk);
      fetched += chunk.length;

      msg(`Agreement一覧を取得中… ページ ${page}/${totalPages} ・ 取得 ${fetched}${totalRecords!=null?`/${totalRecords}`:''}`, 'info');
    }

    const totalMsg = totalRecords != null
      ? `（${fetched}件 / 期待 ${totalRecords}件, 全${totalPages}ページ）`
      : `（${fetched}件 / 全${totalPages}ページ）`;
    msg('Agreement 取得完了 ' + totalMsg, 'success');

  }catch(e){
    msg('通信エラー: ' + e.message, 'error');
  }
}

      // function renderAgreementsTable(items){
      //   const tbody = document.querySelector('#agreementsTable tbody');
      //   tbody.innerHTML = '';
      //   items.forEach(a => {
      //     const tr = document.createElement('tr');
      //     tr.innerHTML =
      //       '<td><button class="detail-btn" data-id="' + escapeHtml(String(a.id)) + '">明細取得</button></td>' +
      //       '<td>' + escapeHtml(String(a.id)) + '</td>' +
      //       '<td>' + escapeHtml(a.name || '') + '</td>' +
      //       '<td>' + escapeHtml((a.startDate || '').slice(0,10)) + '</td>' +
      //       '<td>' + escapeHtml((a.agreementStatus && a.agreementStatus.label) || '') + '</td>';
      //     tbody.appendChild(tr);
      //   });
      //   if(dtAgreements){ dtAgreements.destroy(); }
      //   dtAgreements = $('#agreementsTable').DataTable({
      //     paging:false, searching:true, ordering:true, info:false,
      //     scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 }, scrollY:"260px"
      //   });
      //   dtAgreements.columns.adjust();
      // }

      async function onPickAgreement(agreementId){
        activeAgreementSeq++;
        const seq = activeAgreementSeq;
        selectedAgreementId = agreementId;

        // 行ハイライト
        const allRows = document.querySelectorAll('#agreementsTable tbody tr');
        allRows.forEach(tr => tr.classList.remove('selected-row'));
        const btn = document.querySelector(`.detail-btn[data-id="${agreementId}"]`);
        if (btn) {
          const row = btn.closest('tr');
          if (row) row.classList.add('selected-row');
        }

        // 初期化
        resetLinesUI();
        resetPackageInfoUI();
        resetPackageTitlesUI();
        document.getElementById('loadingMsg').textContent = '';
        msg('Agreement(' + escapeHtml(agreementId) + ') の読み込みを開始しました…');

        // メタデータ & 明細の取得
        await fetchAgreementDetails(agreementId, seq);
        await fetchEntitlements(agreementId, seq); // ここで自動的にパッケージ情報もロードします
      }

      async function fetchAgreementDetails(id, seq){
        msg('Agreement メタデータ取得中…');
        const res = await fetch(`${okapi.base}/erm/sas/${encodeURIComponent(id)}`, {
          headers: { "x-okapi-token": okapi.token }
        });
        if(!res.ok){ msg('Agreement 詳細取得失敗: ' + res.status, 'error'); return; }
        const details = await res.json();
        if(seq !== activeAgreementSeq) return;
        selectedDetails = details;
        msg('Agreement メタデータ取得完了', 'success');
      }

      // ========== Agreement Lines 取得（完了後にパッケージ情報を自動収集） ==========
      async function fetchEntitlements(agreementId, seq){
        const linesBox = document.getElementById('linesBox');
        if (linesBox) linesBox.style.display = 'block';

        setLinesMsg('Agreement Line 取得中…', 'info');

        const perPage = 100;
        let page = 1, totalPages = 1;
        const all = [];
        try{
          let url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
          let res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
          if(!res.ok){ setLinesMsg('Entitlements 取得失敗: ' + res.status, 'error'); return; }
          let data = await res.json();
          if(seq !== activeAgreementSeq) return;
          totalPages = data.totalPages || 1;
          all.push(...(data.results||[]));
          for(page=2; page<=totalPages; page++){
            setLinesMsg(`Agreement Line 取得中… (${page}/${totalPages})`, 'info');
            url = `${okapi.base}/erm/entitlements?filters=owner%3D%3D${encodeURIComponent(agreementId)}&sort=type%3Basc&sort=resource.name%3Basc&sort=reference%3Basc&sort=id%3Basc&stats=true&page=${page}&perPage=${perPage}`;
            res = await fetch(url, { headers: { "x-okapi-token": okapi.token } });
            if(!res.ok){ setLinesMsg('Entitlements 取得失敗: ' + res.status, 'error'); return; }
            data = await res.json();
            if(seq !== activeAgreementSeq) return;
            all.push(...(data.results||[]));
          }

          renderLinesTable(all);
          setLinesMsg(`Agreement Line 取得完了（合計: ${all.length}行）`, 'success');

          const b = document.getElementById('btnDownloadCSVLines');
          if (b) b.disabled = all.length === 0;

          // 🔄 明細からユニークなパッケージIDを抽出し、自動でパッケージ情報を取得
          autoLoadPackageInfoForEntitlements(all);
        }catch(e){ console.error(e); setLinesMsg('通信エラー: ' + e.message, 'error'); }
      }

      function renderLinesTable(items){
        const table = document.getElementById('linesTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        items.forEach(e => {
          const tr = document.createElement('tr');
          tr.setAttribute('data-entitlement-id', e.id || '');

          // 参照から vendorId / packageId を抽出（必要に応じて属性に保持）
          const ref = (e.reference || '').trim();
          let parsed = parseReference3(ref) || parseReference2(ref);
          let pkgId = parsed?.packageId || '';
          let vId = parsed?.vendorId || '';

          if(!pkgId && e.reference_object?.packageData?.id){ pkgId = String(e.reference_object.packageData.id); }
          if(!vId && e.reference_object?.providerId){ vId = String(e.reference_object.providerId); }

          if(pkgId){ tr.setAttribute('data-package-id', String(pkgId)); }
          if(vId){ tr.setAttribute('data-vendor-id', String(vId)); }

          const authority = getAuthority(e);
          const levelBadge = authority === 'EKB-PACKAGE'
            ? '<span class="badge">パッケージ</span>'
            : '<span class="badge">タイトル</span>';

          const cells = [
            levelBadge,
            safe(e.id||''),
            safe(e.reference||''),
            safe(e.reference_object?.label || ''),
            safe(e.reference_object?.provider || ''),
            safe(e.reference_object?.packageData?.name || ''),
            safe(e.reference_object?.publicationType || ''),
            linkCell(e.reference_object?.url || '')
          ];

          tr.innerHTML = cells.map((cell,i)=> (i===7) ? `<td>${cell}</td>` : `<td>${i===0?cell:escapeHtml(cell)}</td>`).join('');
          tbody.appendChild(tr);
        });

        if(dtLines){ dtLines.destroy(); }
        dtLines = $("#linesTable").DataTable({
          paging:false, searching:true, ordering:true, info:false,
          scrollX:true, autoWidth:false, fixedColumns:{ leftColumns:2 },
          scrollY:"220px"
        });
        dtLines.columns.adjust();
      }

      // --- 明細からユニークなパッケージを収集し、自動取得 ---
      async function autoLoadPackageInfoForEntitlements(items){
        // 入力欄から最新の HIQ 資格情報を読む
        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();

        resetPackageInfoUI();
        showPackageInfoBox(true);

        if(!(hiq.apiKey && hiq.customerId)){
          setPackageInfoMsg('HIQ: API Key と Customer ID を入力すると、明細取得と同時にパッケージ情報も自動取得します。', 'info');
          return; // 資格情報が無い場合はスキップ（明細は表示済み）
        }

        // ユニークな packageId を抽出
        const pkgIdSet = new Set();
        for(const e of items){
          const ref = (e.reference || '').trim();
          let parsed = parseReference3(ref) || parseReference2(ref);
          let pkgId = parsed?.packageId || '';
          if(!pkgId && e.reference_object?.packageData?.id){ pkgId = String(e.reference_object.packageData.id); }
          if(pkgId) pkgIdSet.add(String(pkgId));
        }

        const pkgIds = Array.from(pkgIdSet);
        if(pkgIds.length === 0){
          setPackageInfoMsg('この契約明細に紐づくパッケージは見つかりませんでした。', 'info');
          return;
        }

        setPackageInfoMsg(`パッケージ情報を取得中… (0/${pkgIds.length})`);

        const detailsList = [];
        let done = 0;
        for(const pid of pkgIds){
          try{
            const details = await getPackageDetails(pid);
            detailsList.push({ packageId: pid, details });
          }catch(e){
            console.error('getPackageDetails error', pid, e);
            // 🔴 画面に個別エラーメッセージを表示 + テーブルにもエラー行を出す
            appendPackageInfoErr(`Package ID <code class="k">${escapeHtml(String(pid))}</code> の取得に失敗しました: ${escapeHtml(e.message)}`);
            detailsList.push({ packageId: pid, error: e.message });
          }finally{
            done++;
            setPackageInfoMsg(`パッケージ情報を取得中… (${done}/${pkgIds.length})`);
          }
        }

        renderPackageInfoTable(detailsList);
        setPackageInfoMsg(`パッケージ情報の取得完了（${detailsList.length} / ${pkgIds.length}）`, 'success');
      }

      // --- パッケージ情報の取得（単体） ---
      async function getPackageDetails(packageId){
        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();
        if(!(hiq.apiKey && hiq.customerId)){
          throw new Error('HIQ: API Key と Customer ID を入力してください。');
        }
        const headers = { accept: 'application/json', 'x-api-key': hiq.apiKey };
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getPackageDetails.php';
        const url = `${base}?account=${encodeURIComponent(hiq.customerId)}&package=${encodeURIComponent(packageId)}`;
        const res = await fetch(url, { headers });
        if(!res.ok){
          // ステータスだけでなく、どの Package かを出す
          throw new Error(`Package Details(${packageId}) 取得失敗: ${res.status}`);
        }
        return await res.json();
      }

      // --- パッケージ情報テーブル（複数行）描画 ---
      function renderPackageInfoTable(items){
        const table = document.getElementById('packageInfoTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        for(const it of items){
          const packageId = it.packageId;
          const details = it.details || {};

          const tr = document.createElement('tr');
          tr.setAttribute('data-package-id', String(packageId));

          // 🔴 エラー行：詳細が取れなかった場合はテーブルにも明示
          if (it.error){
            tr.innerHTML = [
              '<span class="badge">エラー</span>',
              '',
              escapeHtml(String(packageId)),
              `<span class="error">取得失敗: ${escapeHtml(String(it.error))}</span>`,
              '',
              '',
              '',
              ''
            ].map((c)=>`<td>${c}</td>`).join('');
            tbody.appendChild(tr);
            continue;
          }

          const pkgName  = details?.packageName ?? '';
          const vendor   = details?.vendorName  ?? '';
          const selCount = details?.selectedCount ?? '';
          const ttlCount = details?.titleCount    ?? '';
          const freeAcc  = details?.packageFreeAccess ?? '';
          const vendorId = details?.vendorId != null ? String(details.vendorId) : '';

          const canExpand = typeof details?.titleCount === 'number' && details.titleCount <= 10000;
          const opCell = canExpand
            ? `<button class="btnExpandTitles" data-package-id="${escapeHtml(String(packageId))}" data-vendor-id="${escapeHtml(String(vendorId))}" data-package-name="${escapeHtml(String(pkgName))}">タイトル展開</button>`
            : `パッケージ内のタイトル数が多すぎます。HLMよりDLしてください`;

          if(vendorId) tr.setAttribute('data-vendor-id', String(vendorId));
          tr.innerHTML = [
            opCell,
            escapeHtml(vendorId),
            escapeHtml(String(packageId)),
            escapeHtml(pkgName),
            escapeHtml(vendor),
            escapeHtml(String(selCount)),
            escapeHtml(String(ttlCount)),
            escapeHtml(String(freeAcc))
          ].map((c)=>`<td>${c}</td>`).join('');
          tbody.appendChild(tr);
        }

        showPackageInfoBox(true);
      }

      // --- クリックイベント：タイトル展開 ---
      document.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('.btnExpandTitles');
        if(!btn) return;

        hiq.apiKey     = document.getElementById('hiqApiKey').value.trim();
        hiq.customerId = document.getElementById('hiqCustomerId').value.trim();
        if(!(hiq.apiKey && hiq.customerId)){
          msg('HIQ: API Key と Customer ID を入力してください。','error');
          return;
        }

        const packageId = btn.getAttribute('data-package-id');
        const packageName = btn.getAttribute('data-package-name') || '';
        const vendorId = btn.getAttribute('data-vendor-id') || '';
        if(!packageId){ msg('Package ID を取得できませんでした。','error'); return; }

        // UI 準備
        resetPackageTitlesUI();
        currentPackageIdForTitles = packageId;
        currentPackageNameForTitles = packageName;

        const heading = document.getElementById('packageTitlesHeading');
        if(heading) heading.textContent = `パッケージ内タイトル一覧（Package ${packageId} : ${packageName || 'N/A'}）`;
        showPackageTitlesBox(true);
        setPackageTitlesMsg('タイトルを取得中…');

        try{
          const list = await loadPackageTitles(packageId, vendorId);
          renderPackageTitles(list);
          setPackageTitlesMsg(`取得完了：${list.length} 件`, 'success');

          const b = document.getElementById('btnDownloadCSVTitles');
          if (b) b.disabled = list.length === 0;
        }catch(e){
          console.error(e);
          setPackageTitlesMsg('タイトルの取得に失敗しました: ' + escapeHtml(e.message), 'error');
          const b = document.getElementById('btnDownloadCSVTitles');
          if (b) b.disabled = true;
        }
      });

      // --- パッケージ内タイトル一覧の取得（vendor を付与） ---
      async function loadPackageTitles(packageId, vendorId){
        if(pkgTitlesCache.has(packageId)){
          return pkgTitlesCache.get(packageId).list;
        }
        const headers = { 'accept':'application/json', 'x-api-key': hiq.apiKey };
        const base = 'https://gssapps.ebscohost.com/auchikawa/iq/holdings_getPackageTitles.php';

        const out = [];
        let page = 1;
        const count = 100;
        let total = 0;
        let safety = 2000;

        while (safety-- > 0){
          const url =
            `${base}?account=${encodeURIComponent(hiq.customerId)}` +
            `&vendor=${encodeURIComponent(vendorId||'')}` +
            `&package=${encodeURIComponent(packageId)}` +
            `&count=${count}&offset=${page}&orderby=titlename&searchfield=titlename`;
          const res = await fetch(url, { headers });
          if(!res.ok){
            throw new Error(`holdings_getPackageTitles 失敗: ${res.status}`);
          }
          const data = await res.json();
          const titles = Array.isArray(data.titles) ? data.titles : [];
          total = Number(data.totalResults || 0);

          for(const t of titles){
            const h = hiqFromTitle(t);
            out.push({
              titleName: h.titleName,
              titleId:   h.titleId,
              resourceType: h.resourceType,
              selected: h.selected,
              url: h.url,
              printIssn: h.printIssn,
              onlineIssn: h.onlineIssn,
              printIsbn: h.printIsbn,
              onlineIsbn: h.onlineIsbn
            });
          }

          if(titles.length < count) break;
          const maxPage = total ? Math.ceil(total / count) : Infinity;
          page++;
          if(page > maxPage) break;

          setPackageTitlesMsg(`タイトルを取得中… (${Math.min(out.length, total)}/${total||'?'})`);
        }

        pkgTitlesCache.set(packageId, { list: out, total, name: '' });
        return out;
      }

      // --- タイトル一覧をテーブル描画 ---
      function renderPackageTitles(list){
        const table = document.getElementById('packageTitlesTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        list.forEach((x, i) => {
          const tr = document.createElement('tr');
          const cells = [
            String(i+1),
            safe(x.titleName),
            safe(x.titleId),
            safe(x.resourceType),
            safe(x.selected),
            x.url ? `<a href="${escapeHtml(x.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(x.url)}</a>` : '',
            safe(x.printIssn),
            safe(x.onlineIssn),
            safe(x.printIsbn),
            safe(x.onlineIsbn),
          ];
          tr.innerHTML = cells.map((c, idx)=> idx===5 ? `<td>${c}</td>` : `<td>${escapeHtml(c)}</td>`).join('');
          tbody.appendChild(tr);
        });

        dtPkgTitles = $("#packageTitlesTable").DataTable({
          paging:true, searching:true, ordering:true, info:true,
          pageLength: 25,
          scrollX:true, autoWidth:false
        });
      }

      // --- CSV Export（明細） ---
      function downloadCSVLines(){
        const table = document.getElementById('linesTable');
        const trs = Array.from(table.querySelectorAll('tbody tr'));
        if(!trs.length){ alert('出力するデータがありません'); return; }
        const rows = trs.map(tr => {
          const tds = Array.from(tr.cells);
          const urlA = tds[7]?.querySelector('a');
          const cols = [
            tds[1]?.innerText || '', // Entitlement ID
            tds[0]?.innerText || '', // Level
            tds[2]?.innerText || '', // Reference
            tds[3]?.innerText || '', // Label
            tds[4]?.innerText || '', // Provider
            tds[5]?.innerText || '', // Package Name
            tds[6]?.innerText || '', // Publication Type
            urlA?.getAttribute('href') || '' // URL
          ];
          return cols.map(t => /[",\n]/.test(t) ? '"' + t.replace(/"/g,'""') + '"' : t).join(',');
        });
        const headers = ['Entitlement ID','Level','Reference','Label','Provider','Package Name','Publication Type','URL'];
        const csv = "\uFEFF" + [headers.join(','), ...rows].join('\n');
        downloadBlob(csv, `agreement_lines_${exportBaseName()}_${timestamp()}.csv`);
      }

      // --- CSV Export（タイトル一覧：キャッシュから全件を書き出す） ---
      function downloadCSVTitles(){
        const pkgId = currentPackageIdForTitles;
        const cache = pkgTitlesCache.get(pkgId);
        const list = cache?.list || [];

        if(!pkgId || !list.length){
          alert('出力するデータがありません（タイトル一覧が未取得か0件です）');
          return;
        }

        const rows = list.map(x => {
          const cols = [
            x.titleName || '',
            x.titleId || '',
            x.resourceType || '',
            x.selected || '',
            x.url || '',
            x.printIssn || '',
            x.onlineIssn || '',
            x.printIsbn || '',
            x.onlineIsbn || ''
          ];
          return cols.map(t => /[",\n]/.test(String(t)) ? '"' + String(t).replace(/"/g,'""') + '"' : String(t)).join(',');
        });

        const headers = ['Title name','Title ID','Resource type','Selected','URL','Print ISSN','Online ISSN','Print ISBN','Online ISBN'];
        const csv = "\uFEFF" + [headers.join(','), ...rows].join('\n');

        const baseName = (currentPackageNameForTitles || `package_${pkgId}`).replace(/[^a-zA-Z0-9_-]+/g,'_');
        downloadBlob(csv, `package_titles_${baseName}_${timestamp()}.csv`);
      }

      // --- 共通：ダウンロード処理 ---
      function downloadBlob(text, filename){
        const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function timestamp(){
        const now = new Date(), pad=n=>String(n).padStart(2,'0');
        return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      }
      function exportBaseName(){
        return (selectedDetails && selectedDetails.name)
          ? selectedDetails.name.replace(/[^a-zA-Z0-9_-]+/g,'_')
          : (selectedAgreementId||'export');
      }

      function resetLinesUI(){
        const currentTable = document.getElementById('linesTable');
        if(!currentTable) return;
        const wrapper = currentTable.closest('.table-wrapper') || currentTable.parentElement;

        if(!linesTableTemplateHTML){
          linesTableTemplateHTML = currentTable.outerHTML;
        }

        try{
          if ($.fn.DataTable.isDataTable(currentTable)) {
            $(currentTable).DataTable().destroy(true);
          }
        }catch(_){ /* noop */ }
        dtLines = null;

        if(wrapper){
          wrapper.innerHTML = linesTableTemplateHTML;
        }
        const linesBox = document.getElementById('linesBox');
        if (linesBox) linesBox.style.display = 'none';

        const b = document.getElementById('btnDownloadCSVLines');
        if (b) b.disabled = true;
      }

      // --- ユーティリティ ---
      function hiqFromTitle(t){
        const cr = Array.isArray(t.customerResourcesList) && t.customerResourcesList.length ? t.customerResourcesList[0] : {};
        const ids = splitIdentifiers(t.identifiersList || []);
        const { begin: managedBegin, end: managedEnd } = firstCoverage(cr.managedCoverageList);
        const { begin: customBegin,  end: customEnd  } = firstCoverage(cr.customCoverageList);

        return {
          providerName: cr?.vendorName ?? t?.vendorName ?? '',
          packageName:  cr?.packageName  ?? t?.packageName  ?? '',
          titleName: t.titleName || '',
          titleId:   String(t?.titleId ?? t?.kbid ?? t?.kbId ?? ''),
          packageId: String(cr?.packageId ?? t?.listId ?? ''),
          providerId: String(cr?.vendorId ?? t?.vendorId ?? ''),
          resourceType: t.pubType || '',
          coverageManagedBegin: managedBegin,
          coverageManagedEnd:   managedEnd,
          coverageCustomBegin:  customBegin,
          coverageCustomEnd:    customEnd,
          url: cr?.url ?? t?.url ?? '',
          printIssn: ids.printIssn,
          onlineIssn: ids.onlineIssn,
          printIsbn: ids.printIsbn,
          onlineIsbn: ids.onlineIsbn,
          selected: cr && cr.isSelected ? 'Selected' : 'Not selected',
          label1: cr?.userDefinedField1 ?? t?.userDefinedField1 ?? '',
          label2: cr?.userDefinedField2 ?? t?.userDefinedField2 ?? '',
          label3: cr?.userDefinedField3 ?? t?.userDefinedField3 ?? '',
          label4: cr?.userDefinedField4 ?? t?.userDefinedField4 ?? '',
          label5: cr?.userDefinedField5 ?? t?.userDefinedField5 ?? '',
          rootProxy: cr && cr.proxy && cr.proxy.proxiedUrl ? cr.proxy.proxiedUrl : ''
        };
      }

      function firstCoverage(list){
        try{
          const c = Array.isArray(list) && list.length ? list[0] : null;
          return {
            begin: (c && c.beginCoverage) || '',
            end:   (c && c.endCoverage)   || ''
          };
        }catch(_){ return { begin:'', end:'' }; }
      }
      function splitIdentifiers(list){
        const out = { printIssn:'', onlineIssn:'', printIsbn:'', onlineIsbn:'' };
        try{
          const bySource = { 'Print ISSN': [], 'Online ISSN': [], 'Print ISBN': [], 'Online ISBN': [] };
          (list||[]).forEach(x => { if(!x || !x.id) return; if(bySource[x.source]) bySource[x.source].push(String(x.id)); });
          out.printIssn = bySource['Print ISSN'].join('; ');
          out.onlineIssn = bySource['Online ISSN'].join('; ');
          out.printIsbn = bySource['Print ISBN'].join('; ');
          out.onlineIsbn = bySource['Online ISBN'].join('; ');
        }catch(_){ /* noop */ }
        return out;
      }

      function safe(v){ return v==null? '': String(v); }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function linkCell(u){ if(!u) return ''; const esc = escapeHtml(String(u)); return `<a href="${esc}" target="_blank" rel="noopener noreferrer">${esc}</a>`; }

      function getAuthority(e){
        const a = (e.resource && e.resource.authority) || e.authority || (e.reference_object && e.reference_object.authority);
        if(a) return a;
        const ref = (e.reference || '').trim();
        if(parseReference3(ref)) return 'EKB-TITLE';
        if(parseReference2(ref)) return 'EKB-PACKAGE';
        return '';
      }
      function parseReference3(ref){ // 36 - 1515 - 968431
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2], kbId: m[3] };
      }
      function parseReference2(ref){ // 36 - 1515
        const m = ref.match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
        if(!m) return null;
        return { vendorId: m[1], packageId: m[2] };
      }

      document.getElementById('btnLogin').addEventListener('click', login);
      document.getElementById('btnReloadAgreements').addEventListener('click', loadAgreements);

      // Agreement一覧の「明細取得」ボタン
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.detail-btn');
        if(btn){
          const id = btn.getAttribute('data-id') || '';
          if(id){ onPickAgreement(id); }
          else { msg('Agreement ID を取得できませんでした。','error'); }
        }
      });

      // CSVダウンロード（明細）
      document.getElementById('btnDownloadCSVLines').addEventListener('click', downloadCSVLines);
      // CSVダウンロード（タイトル）
      document.getElementById('btnDownloadCSVTitles').addEventListener('click', downloadCSVTitles);
    </script>
  </body>
</html>
