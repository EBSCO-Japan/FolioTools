<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>FOLIO Licenses 更新</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .form-container {
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      label {
        display: block;
        margin: 10px 0;
        font-size: 14px;
      }
      input[type="text"],
      input[type="password"],
      input[type="file"] {
        padding: 10px;
        width: 100%;
        max-width: 400px;
        box-sizing: border-box;
        margin-top: 5px;
      }
      button {
        padding: 10px 20px;
        margin-top: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #0056b3;
      }
      .success {
        color: #155724;
        background: #d4edda;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .error {
        color: #721c24;
        background: #f8d7da;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .info {
        color: #004085;
        background: #cce5ff;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2>FOLIO Licenses CSV Manager</h2>
      <label>
        Base URL:
        <input
          type="text"
          id="baseUrl"
          value="https://folio-quesnelia-okapi.dev.folio.org"
        />
      </label>
      <label>
        Tenant:
        <input type="text" id="tenant" value="diku" />
      </label>
      <label>
        Username:
        <input type="text" id="username" value="diku_admin" />
      </label>
      <label>
        Password:
        <input type="password" id="password" value="admin" />
      </label>
      <button id="fetchBtn">CSVダウンロード</button>
      <label>
        CSVアップロード:
        <input type="file" id="csvFile" accept=".csv" />
      </label>
      <button id="uploadBtn">CSVアップロード実行</button>
      <div id="message"></div>
      <div id="uploadResults"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
      document
        .getElementById("fetchBtn")
        .addEventListener("click", fetchAndDownload);
      document
        .getElementById("uploadBtn")
        .addEventListener("click", uploadFromCSV);

      // Custom Properties のメタ情報を取得 (キーと ctx)
      async function fetchCustomProps(baseUrl, tenant, token) {
        const customPropsMeta = [];
        let page = 1;
        let totalPages = 1;
        const max = 100;

        do {
          const url = `${baseUrl}/licenses/custprops?sort=ctx%3Basc&sort=weight%3Basc&max=${max}&stats=true&filters=retired%3D%3Dfalse&page=${page}`;
          const res = await fetch(url, {
            headers: {
              "x-okapi-tenant": tenant,
              "x-okapi-token": token,
            },
          });
          if (!res.ok) break;
          const data = await res.json();
          totalPages = data.totalPages || 1;
          (data.results || []).forEach((prop) => {
            if (prop.name) {
              customPropsMeta.push({
                key: prop.name,
                ctx: prop.ctx || "",
              });
            }
          });
          page++;
        } while (page <= totalPages);

        return customPropsMeta;
      }

      async function fetchAndDownload() {
        const baseUrl = document.getElementById("baseUrl").value;
        const tenant = document.getElementById("tenant").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const messageEl = document.getElementById("message");
        const fetchBtn = document.getElementById("fetchBtn");

        messageEl.innerHTML = '<div class="info">取得中…</div>';
        fetchBtn.disabled = true;

        let token;
        try {
          const loginRes = await fetch(`${baseUrl}/authn/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-okapi-tenant": tenant,
            },
            body: JSON.stringify({ username, password }),
          });
          if (!loginRes.ok) throw new Error("認証失敗");
          token = loginRes.headers.get("x-okapi-token");
        } catch (err) {
          messageEl.innerHTML = '<div class="error">認証に失敗しました</div>';
          fetchBtn.disabled = false;
          return;
        }

        try {
          // Custom Properties メタ情報取得（ctx と key）
          const customPropsMeta = await fetchCustomProps(baseUrl, tenant, token);
          const customKeysOrdered = customPropsMeta.map((c) => c.key);

          const licenseRows = [];
          let page = 1;
          const perPage = 100;
          let totalPages = 1;

          do {
            const res = await fetch(
              `${baseUrl}/licenses/licenses?stats=true&page=${page}&perPage=${perPage}`,
              {
                headers: {
                  "x-okapi-tenant": tenant,
                  "x-okapi-token": token,
                },
              }
            );
            if (!res.ok) break;
            const data = await res.json();
            totalPages = data.totalPages || 1;
            (data.results || []).forEach((lic) => {
              const base = {
                id: lic.id,
                created: lic.dateCreated?.slice(0, 10) || "",
                name: lic.name,
                status: lic.status?.label || "",
              };
              const custom = {};
              Object.entries(lic.customProperties || {}).forEach(
                ([key, items]) => {
                  if (!Array.isArray(items) || items.length === 0) return;
                  // reference: take first item (multiselect or others)
                  const item = items[0];
                  const v = item.value;
                  let displayValue = "";
                  if (Array.isArray(v)) {
                    displayValue = v
                      .map((x) => x.label || String(x))
                      .join("; ");
                  } else if (v && typeof v === "object") {
                    displayValue = v.label || "";
                  } else {
                    displayValue = String(v);
                  }
                  custom[key] = displayValue;
                }
              );
              licenseRows.push({ base, custom });
            });
            page++;
          } while (page <= totalPages);

          if (!licenseRows.length) {
            messageEl.innerHTML =
              '<div class="error">ライセンスが見つかりませんでした。</div>';
            fetchBtn.disabled = false;
            return;
          }

          // CSV ヘッダー作成（二段ヘッダー）
          const defaultHeaders = ["id", "created", "name", "status"];
          // 1行目: defaultHeaders 分空（""）、続いて ctx（適切にエスケープ）
          const header1Parts = [];
          defaultHeaders.forEach(() => {
            header1Parts.push('""');
          });
          customPropsMeta.forEach(({ ctx }) => {
            const escaped = `"${(ctx || "").replace(/"/g, '""')}"`;
            header1Parts.push(escaped);
          });
          const header1 = header1Parts.join(",");

          // 2行目: defaultHeaders + custom property keys
          const header2Parts = defaultHeaders.map(
            (h) => `"${h.replace(/"/g, '""')}"`
          );
          customKeysOrdered.forEach((k) => {
            header2Parts.push(`"${k.replace(/"/g, '""')}"`);
          });
          const header2 = header2Parts.join(",");

          // データ行
          const dataRows = licenseRows.map(({ base, custom }) => {
            const rowParts = [];
            defaultHeaders.forEach((h) => {
              let val = base[h] !== undefined ? base[h] : "";
              if (/[",\n]/.test(val)) val = `"${val.replace(/"/g, '""')}"`;
              rowParts.push(val);
            });
            customKeysOrdered.forEach((key) => {
              let val = custom[key] || "";
              if (/[",\n]/.test(val)) val = `"${val.replace(/"/g, '""')}"`;
              rowParts.push(val);
            });
            return rowParts.join(",");
          });

          const body = [header1, header2, ...dataRows].join("\n");
          const csvContent = "\uFEFF" + body;
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const now = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          const ts = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(
            now.getDate()
          )}${pad(now.getHours())}${pad(now.getMinutes())}${pad(
            now.getSeconds()
          )}`;
          a.href = url;
          a.download = `licenses_${ts}.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          messageEl.innerHTML =
            '<div class="success">CSVのダウンロードが完了しました！</div>';
        } catch (err) {
          console.error(err);
          messageEl.innerHTML = '<div class="error">エラーが発生しました</div>';
        } finally {
          fetchBtn.disabled = false;
        }
      }

      async function uploadFromCSV() {
        const fileInput = document.getElementById("csvFile");
        const baseUrl = document.getElementById("baseUrl").value;
        const tenant = document.getElementById("tenant").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const messageEl = document.getElementById("message");
        const resultsEl = document.getElementById("uploadResults");
        const uploadBtn = document.getElementById("uploadBtn");

        if (!fileInput.files.length) {
          messageEl.innerHTML =
            '<div class="error">CSVファイルを選択してください</div>';
          return;
        }
        uploadBtn.disabled = true;
        messageEl.innerHTML = '<div class="info">アップロード中…</div>';

        // Authenticate to get token
        let token;
        try {
          const loginRes = await fetch(`${baseUrl}/authn/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-okapi-tenant": tenant,
            },
            body: JSON.stringify({ username, password }),
          });
          if (!loginRes.ok) throw new Error("認証失敗");
          token = loginRes.headers.get("x-okapi-token");
        } catch (err) {
          messageEl.innerHTML = '<div class="error">認証に失敗しました</div>';
          uploadBtn.disabled = false;
          return;
        }

        const file = fileInput.files[0];
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          // ヘッダー名の先頭にある \uFEFF を取り除く
          transformHeader: (header) => header.replace(/^\uFEFF/, ""),
          complete: async function (results) {
            const data = results.data;
            const tableRows = [];

            for (const row of data) {
              const id = row["id"];
              if (!id) continue;

              // まずGETで既存ライセンスを取得
              let payload;
              try {
                const getRes = await fetch(`${baseUrl}/licenses/licenses/${id}`, {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                    "x-okapi-tenant": tenant,
                    "x-okapi-token": token,
                  },
                });
                if (!getRes.ok) throw new Error("GET失敗");
                payload = await getRes.json();
              } catch (err) {
                tableRows.push({
                  ID: id,
                  status: "Error",
                  detail: `GET失敗: ${err.message}`,
                });
                continue;
              }

              // Base fields: name, status もCSVで上書き
              if (row["name"] !== undefined) payload.name = row["name"];
              if (row["status"] !== undefined) payload.status = row["status"];

              // Custom properties
              if (!payload.customProperties) payload.customProperties = {};
              Object.keys(row).forEach((col) => {
                if (!col.startsWith("customProperties.")) return;
                const key = col.replace("customProperties.", "");
                const val = row[col].trim();
                if (!(key in payload.customProperties)) {
                  // 既存にない場合は従来通りvalueにセット
                  payload.customProperties[key] = val
                    ? [{ _delete: false, value: val }]
                    : [{ _delete: true }];
                  return;
                }
                // 既存の型に応じて上書き
                const arr = payload.customProperties[key];
                if (!Array.isArray(arr) || arr.length === 0) {
                  payload.customProperties[key] = val
                    ? [{ _delete: false, value: val }]
                    : [{ _delete: true }];
                  return;
                }
                // 1件目のみ上書き（複数ある場合はMultiselect想定）
                if (Array.isArray(arr[0].value)) {
                  // Multiselect: valueが配列
                  if (val) {
                    // CSV値を;区切りで分割
                    const vals = val
                      .split(/;|；/)
                      .map((v) => v.trim())
                      .filter(Boolean);
                    arr[0].value = vals.map((v) => ({ value: v }));
                    arr[0]._delete = false;
                  } else {
                    arr[0].value = [];
                    arr[0]._delete = true;
                  }
                } else if (
                  arr[0].value &&
                  typeof arr[0].value === "object" &&
                  "value" in arr[0].value
                ) {
                  // value.value型
                  if (val) {
                    arr[0].value.value = val;
                    arr[0]._delete = false;
                  } else {
                    arr[0]._delete = true;
                  }
                } else {
                  // value型
                  if (val) {
                    arr[0].value = val;
                    arr[0]._delete = false;
                  } else {
                    arr[0]._delete = true;
                  }
                }
              });

              // PUT request
              try {
                console.log(JSON.stringify(payload));
                const res = await fetch(`${baseUrl}/licenses/licenses/${id}`, {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    "x-okapi-tenant": tenant,
                    "x-okapi-token": token,
                  },
                  body: JSON.stringify(payload),
                });
                let result = {};
                try {
                  result = await res.json();
                } catch {}
                tableRows.push({
                  ID: id,
                  status: res.ok ? "OK" : "Error",
                  detail: res.ok ? JSON.stringify(result) : res.statusText,
                });
              } catch (err) {
                tableRows.push({
                  ID: id,
                  status: "Error",
                  detail: err.message,
                });
              }
            }

            // Render results table
            let html =
              "<table><thead><tr><th>ID</th><th>結果</th><th>詳細</th></tr></thead><tbody>";
            tableRows.forEach((r) => {
              html += `<tr><td>${r.ID}</td><td>${r.status}</td><td>${r.detail}</td></tr>`;
            });
            html += "</tbody></table>";
            resultsEl.innerHTML = html;
            messageEl.innerHTML =
              '<div class="success">アップロード完了！</div>';
            uploadBtn.disabled = false;
          },
          error: function (err) {
            messageEl.innerHTML = `<div class="error">CSV解析エラー: ${err.message}</div>`;
            uploadBtn.disabled = false;
          },
        });
      }
    </script>
  </body>
</html>
